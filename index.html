<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚合搜索导航 (云同步版)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* CSS Variables */
        :root {
            --blue: #8ab4f8;
            --bg: #17181a;
            --card-bg: #202124;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --border-color: #3c4043;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --hover-shadow-color: rgba(0, 0, 0, 0.35);
            --focus-shadow-color: rgba(138, 180, 248, 0.25);
            --ios-glass-bg: rgba(45, 45, 45, 0.75);
            --rebound-easing: cubic-bezier(0.34, 1.56, 0.64, 1);
            --nav-item-size: 100px; 
        }

        /* 全局和基础样式 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body {
            background: var(--bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite;
            will-change: background-position;
        }
        
        body[data-theme="aurora"]::before { background-image: linear-gradient(315deg, #8ab4f8, #34a853, #fbbc05, #ea4335); opacity: 0.2; }
        body[data-theme="sunset"]::before { background-image: linear-gradient(315deg, #f83600, #f9d423, #ff512f, #dd2476); opacity: 0.25; }
        body[data-theme="ocean"]::before { background-image: linear-gradient(315deg, #21d4fd, #b721ff, #08aeea, #2af598); opacity: 0.2; }
        body[data-theme="neon"]::before { background-image: linear-gradient(315deg, #f800b7, #7f00ff, #0072ff, #00bfff); opacity: 0.25; }
        body[data-theme="forest"]::before { background-image: linear-gradient(315deg, #228b22, #556b2f, #8fbc8f, #2e8b57); opacity: 0.2; }
        body[data-theme="cosmic"]::before { background-image: linear-gradient(315deg, #1e0033, #330066, #ffcc00, #cc00ff); opacity: 0.3; }

        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.95) translateY(-5px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        /* 头部和搜索栏 */
        header {
            flex-shrink: 0;
            position: relative;
            background: var(--ios-glass-bg);
            backdrop-filter: blur(16px) saturate(180%); 
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            padding: 14px 10px; border-bottom: 1px solid var(--border-color); z-index: 100;
            transition: transform 0.8s var(--rebound-easing);
            will-change: transform;
        }
        body.curtain-active header { transform: translateY(-100%); }
        .header-content { display: flex; align-items: center; justify-content: center; max-width: 960px; margin: 0 auto; }
        .header-btn {
            display: inline-flex; align-items: center; justify-content: center;
            background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 0 16px; height: 48px; border-radius: 24px; cursor: pointer;
            font-size: 16px; white-space: nowrap; transition: all 0.2s ease, transform 0.2s var(--rebound-easing);
        }
        .header-btn:not(:disabled):hover {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--blue);
            color: var(--blue);
        }
        .header-btn-icon { width: 20px; height: 20px; margin-right: 8px; fill: currentColor; }
        .home-btn { margin-right: 10px; }
        .ai-btn-container, .theme-btn-container, #user-actions-container { position: relative; margin-left: 10px; }

        /* 登录后用户按钮的新样式 (胶囊状) */
        #user-btn {
            padding: 6px 16px 6px 6px;
            background: var(--ios-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px; /* 胶囊形状 */
            height: 48px;
        }
        .user-icon-wrapper {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 18px;
            font-weight: 500;
            flex-shrink: 0;
        }
        #user-btn:not(:disabled):hover {
            background: rgba(45, 45, 45, 0.9);
        }

        /* 搜索容器 */
        .search-container {
            position: relative; display: flex; align-items: center; width: 100%;
            background: var(--card-bg); border-radius: 24px; border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .search-container:hover, .search-container:focus-within {
            border-color: var(--blue); 
            box-shadow: 0 0 0 4px var(--focus-shadow-color);
        }
        .category-dropdown { position: relative; flex-shrink: 0; }
        .dropdown-toggle {
            display: flex; align-items: center; background: none; border: none;
            padding: 0 8px 0 16px; height: 46px; cursor: pointer;
            color: var(--text-primary); font-size: 14px;
        }
        #selected-category-content { display: inline-flex; align-items: center; gap: 8px; }
        .dropdown-toggle svg { width: 16px; height: 16px; margin-left: 4px; fill: currentColor; transition: transform 0.3s ease; }
        .dropdown-toggle[aria-expanded="true"] svg { transform: rotate(180deg); }
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--ios-glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px;
            min-width: 160px;
            z-index: 120;
            transform-origin: top left;
            animation: fadeInScaleUp 0.3s var(--rebound-easing) forwards;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .dropdown-menu.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .ai-dropdown-menu, .theme-btn-container .dropdown-menu, #shape-select-menu, #user-menu {
            right: 0; left: auto; transform-origin: top right;
        }
        .dropdown-item {
            display: flex; align-items: center;
            padding: 10px 14px; color: var(--text-primary); text-decoration: none;
            border-radius: 10px; font-size: 15px;
            transition: background-color 0.2s ease;
        }
        .dropdown-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .dropdown-item-favicon { width: 16px; height: 16px; margin-right: 10px; border-radius: 4px; }
        #search-form { display: flex; flex-grow: 1; align-items: center; }
        #search-input {
            width: 100%; height: 46px; border: none; padding: 0 10px;
            font-size: 16px; outline: none; background: transparent; color: var(--text-primary);
        }
        .search-btn {
            flex-shrink: 0; width: 48px; height: 100%; background: transparent;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: color 0.2s ease;
            border-radius: 0 24px 24px 0;
        }
        .search-btn svg { width: 22px; height: 22px; }
        .search-btn:hover { color: var(--blue); }
        #clock { font-size: 16px; font-weight: 500; color: var(--text-secondary); padding: 0 16px; margin-left: 10px; }

        /* 模态框, 特别是认证相关的 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .modal-overlay.is-dropdown {
            background-color: transparent; backdrop-filter: none;
            align-items: flex-start; justify-content: flex-end;
        }
        .modal-overlay:not(.is-dropdown) {
             background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content {
            background: var(--card-bg); padding: 24px; border-radius: 16px;
            width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95); transition: transform 0.3s var(--rebound-easing);
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { margin: 0 0 24px 0; color: var(--text-primary); text-align: center; }

        #auth-modal, #forgot-password-modal {
            position: absolute;
            top: 70px;
            right: 10px;
        }
        #auth-modal .modal-content, #forgot-password-modal .modal-content, #info-modal .modal-content {
            background: #292a2d; border-radius: 12px;
            padding: 32px; width: 360px; max-width: 90vw;
        }
        #auth-modal .modal-content, #forgot-password-modal .modal-content {
            transform-origin: top right;
        }
        #info-modal .modal-content p {
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
        }

        .auth-form-group { margin-bottom: 16px; }
        .auth-form-group input {
            width: 100%; padding: 12px 14px; background: #3c4043;
            border: 1px solid #5f6368; border-radius: 10px;
            font-size: 15px; color: var(--text-primary);
        }
        .auth-form-group input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px var(--focus-shadow-color); outline: none; }
        .auth-actions { margin-top: 24px; }
        .auth-btn {
            width: 100%; padding: 12px; border-radius: 10px;
            background-color: var(--blue); color: #202124;
            font-size: 16px; font-weight: 500; border: none; cursor: pointer;
        }
        .auth-error-message {
            color: #f28b82; font-size: 14px; text-align: center;
            margin-top: -10px; margin-bottom: 15px; min-height: 1.2em;
        }
        .auth-switch-link { text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-secondary); }
        .auth-switch-link a { color: var(--blue); text-decoration: none; cursor: pointer; font-weight: 500; }
        .auth-switch-link a:hover { text-decoration: underline; }
        #forgot-password-link { margin-top: 10px; font-size: 13px; }
        .modal-btn {
            padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer;
            font-size: 15px; font-weight: 500; transition: all 0.2s;
        }
        .modal-btn.cancel { background-color: transparent; color: var(--text-secondary); }
        .modal-btn.cancel:hover { background-color: rgba(255,255,255,0.05); }
        .modal-btn.save { background-color: var(--blue); color: var(--bg); }
        
        /* 天气 */
        #weather-toggle-btn {
            position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px;
            background: var(--card-bg); border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 12px var(--hover-shadow-color); z-index: 210;
            transition: transform 0.5s var(--rebound-easing);
        }
        #weather-toggle-btn:hover { transform: scale(1.1) rotate(15deg); }
        #weather-toggle-btn.active { transform: scale(1.1) rotate(360deg); }
        #weather-toggle-btn svg { width: 28px; height: 28px; color: #fbbc05; }
        #weather-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            z-index: 200; background: var(--ios-glass-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            padding: 80px 20px 30px; overflow-y: auto;
            transform: translateY(-100%); transition: transform 0.7s var(--rebound-easing);
            will-change: transform;
        }
        #weather-panel.visible { transform: translateY(0); }
        #weather-content { max-width: 960px; margin: 0 auto; }
        
        /* 页面其余部分样式，保持不变 */
        .hidden { display: none !important; }
        #content-wrapper, #curtain-panel, #dynamic-island-wrapper, .nav-grid, main, #iframe-toolbar, #size-slider-panel { /* 省略大量重复样式 */ }
        /* 仅为简洁起见，此处省略了之前版本中未作修改的其余样式 (如 curtain-panel, nav-grid 等) */
        /* 实际使用时，请确保所有样式都在此处 */
        
        /* 确保所有必要的样式都在这里 */
        main { padding: 20px 16px 40px; overflow-y: auto; height: 100%; }
        #content-wrapper { flex-grow: 1; position: relative; height: calc(100vh - 78px); }
    </style>
</head>
<body data-theme="aurora">
    <header>
         <div class="header-content">
             <button id="home-btn" class="header-btn home-btn">
                 <svg class="header-btn-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                 <span>灵动窗</span>
             </button>
             <div class="search-container">
                 <div class="category-dropdown">
                     <button type="button" id="dropdown-toggle" class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
                         <span id="selected-category-content"></span>
                         <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"></path></svg>
                     </button>
                     <div id="dropdown-menu" class="dropdown-menu" role="menu"></div>
                 </div>
                 <form id="search-form" role="search">
                     <input id="search-input" placeholder="聚合搜索软件…" autocomplete="off">
                     <button type="submit" class="search-btn" aria-label="搜索">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                     </button>
                 </form>
             </div>
             <div id="clock"></div>
              <div class="ai-btn-container">
                 <button id="ai-btn" class="header-btn ai-btn" aria-haspopup="true" aria-expanded="false">
                     <svg class="header-btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5l1.06 2.16L15.5 5.5l-2.16 1.06L12 8.5l-1.06-2.16L8.5 5.5l2.16-1.06z M5 10l1.5 3L8 14.5l-1.5 1.5-1.5 3-1.5-3L2 14.5l1.5-1.5z M19 10l1.5 3L22 14.5l-1.5 1.5-1.5 3-1.5-3L16 14.5l1.5-1.5z"></path></svg>
                     <span>AI</span>
                 </button>
                 <div class="dropdown-menu ai-dropdown-menu" role="menu"></div>
             </div>
             <div class="theme-btn-container">
                  <button id="theme-btn" class="header-btn theme-btn" aria-haspopup="true" aria-expanded="false">
                     <svg class="header-btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                 </button>
                 <div class="dropdown-menu theme-dropdown-menu" role="menu"></div>
             </div>
             <div id="user-actions-container"></div>
        </div>
    </header>
    
    <div id="content-wrapper">
       <div id="main-content" class="content-pane active">
           <main>
                <div id="initial-view">
                    <p>双击空白处，开启灵动窗</p>
                    <p style="font-size: 14px; margin-top: 10px;">登录后可同步您的个性化设置</p>
                </div>
           </main>
       </div>
    </div>

    <div id="weather-panel">
        <div id="weather-content"></div>
    </div>
    <div id="weather-toggle-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.99 4.58zm12.02 12.02c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zM4.58 18.01c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0l-1.06-1.06c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l1.06 1.06zm12.02-12.02c.39.39.39 1.02 0 1.41-.39.39-1.02-.39-1.41 0l-1.06-1.06c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l1.06 1.06z"></path></svg>
    </div>

    <div id="auth-modal" class="modal-overlay is-dropdown" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3 id="auth-title">登录</h3>
            <form id="auth-form">
                <div class="auth-form-group" id="nickname-group">
                    <input type="text" id="auth-nickname" placeholder="昵称" autocomplete="nickname">
                </div>
                <div class="auth-form-group">
                    <input type="text" id="auth-username" placeholder="邮箱" required autocomplete="username">
                </div>
                <div class="auth-form-group">
                    <input type="password" id="auth-password" placeholder="密码" required autocomplete="current-password">
                </div>
                <div id="auth-error" class="auth-error-message"></div>
                <div class="auth-actions">
                    <button id="auth-submit-btn" type="submit" class="auth-btn">登录</button>
                </div>
            </form>
            <p id="auth-switch" class="auth-switch-link">还没有账户？<a>立即注册</a></p>
            <p id="forgot-password-link" class="auth-switch-link"><a>忘记密码？</a></p>
        </div>
    </div>
    
    <div id="forgot-password-modal" class="modal-overlay is-dropdown" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>重设密码</h3>
            <form id="forgot-password-form">
                <div class="auth-form-group">
                    <input type="email" id="forgot-email-input" placeholder="请输入您注册时使用的邮箱" required autocomplete="email">
                </div>
                <div id="forgot-error" class="auth-error-message"></div>
                <div class="auth-actions">
                    <button type="submit" class="auth-btn">发送重设邮件</button>
                </div>
            </form>
             <div class="modal-actions" style="justify-content: center; margin-top: 15px;">
                <button type="button" class="modal-btn cancel" data-action="close-modal">返回登录</button>
            </div>
        </div>
    </div>
    
    <div id="info-modal" class="modal-overlay" role="alertdialog" aria-modal="true">
        <div class="modal-content">
            <h3 id="info-modal-title">提示</h3>
            <p id="info-modal-message" style="margin: 20px 0;"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button type="button" id="info-modal-btn" class="modal-btn save" data-action="close-modal">好的</button>
            </div>
        </div>
    </div>
    
    <script>
        // IIFE 封装
        (() => {
            'use strict';

            // =================================================================
            // == 1. 配置区域
            // =================================================================
            const LEANCLOUD_CONFIG = {
                appId: "7Vo87apph5SCxcW1KFnR2OFC-MdYXbMMI",
                appKey: "lnYVUVFSZkXdu6yYO3GOVljz",
            };

            const STATIC_CONFIG = {
                // 省略静态配置内容以保持简洁,实际代码中应包含
            };

            // =================================================================
            // == 2. 应用状态管理
            // =================================================================
            const state = {
                isLoggedIn: false,
                isRegisterMode: false,
                currentUser: null,
                weatherRendered: false,
            };

            // =================================================================
            // == 3. DOM 元素缓存
            // =================================================================
            const dom = {};
            const DOMElementsToCache = [
                'body', 'header', 'home-btn', 'search-form', 'search-input', 
                'main-content', 'initial-view', 'dropdown-toggle', 'dropdown-menu',
                'selected-category-content', 'user-actions-container', 'clock',
                'auth-modal', 'auth-title', 'auth-form', 'auth-nickname', 'auth-username',
                'auth-password', 'auth-error', 'auth-submit-btn', 'auth-switch', 'nickname-group',
                'forgot-password-link', 'forgot-password-modal', 'forgot-password-form', 'forgot-error',
                'info-modal', 'info-modal-title', 'info-modal-message', 'info-modal-btn',
                'weather-toggle-btn', 'weather-panel', 'weather-content'
            ];

            // =================================================================
            // == 4. 工具函数
            // =================================================================
            const utils = {
                showInfoModal: (title, message) => {
                    dom.infoModalTitle.textContent = title;
                    dom.infoModalMessage.textContent = message;
                    dom.infoModal.classList.add('visible');
                },
                closeAllDropdowns: () => {
                    document.querySelectorAll('.dropdown-menu.visible').forEach(menu => menu.classList.remove('visible'));
                    document.querySelectorAll('.modal-overlay.is-dropdown.visible').forEach(modal => modal.classList.remove('visible'));
                    document.querySelectorAll('[aria-haspopup="true"][aria-expanded="true"]').forEach(btn => btn.setAttribute('aria-expanded', 'false'));
                }
            };
            
            // =================================================================
            // == 5. 核心逻辑
            // =================================================================
            const core = {
                register: async (username, password) => {
                    const nickname = dom.authNickname.value.trim();
                    if (!nickname) {
                        dom.authError.textContent = '昵称不能为空！';
                        throw new Error('昵称不能为空');
                    }
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(username)) {
                        dom.authError.textContent = '请输入有效的邮箱地址作为用户名！';
                        throw new Error('邮箱格式无效');
                    }
                    
                    const user = new AV.User();
                    user.setUsername(username);
                    user.setEmail(username);
                    user.setPassword(password);
                    user.set('nickname', nickname);
            
                    try {
                        await user.signUp();
                        utils.showInfoModal('注册成功', `欢迎 ${nickname}！已为您自动登录。`);
                        await core.handleLoginSuccess();
                    } catch (error) {
                        dom.authError.textContent = error.rawMessage || '注册失败，请稍后再试';
                        throw error;
                    }
                },
                login: async (username, password) => {
                    try {
                        await AV.User.logIn(username, password);
                        await core.handleLoginSuccess();
                    } catch (error) {
                        dom.authError.textContent = error.rawMessage || '登录失败，请检查用户名和密码';
                        throw error;
                    }
                },
                logout: async () => {
                    try {
                        await AV.User.logOut();
                        state.isLoggedIn = false;
                        state.currentUser = null;
                        utils.closeAllDropdowns();
                        render.userActions();
                        utils.showInfoModal('成功', '您已退出登录。');
                    } catch (error) {
                        console.error("退出登录失败:", error);
                    }
                },
                handleLoginSuccess: async () => {
                    state.currentUser = AV.User.current();
                    state.isLoggedIn = true;
                    utils.closeAllDropdowns();
                    render.userActions();
                },
                handlePasswordReset: async (email) => {
                    try {
                        await AV.User.requestPasswordReset(email);
                        dom.forgotPasswordModal.classList.remove('visible');
                        utils.showInfoModal('邮件已发送', '如果该邮箱已注册，一封重设密码的邮件将会发送到您的收件箱，请注意查收。');
                    } catch (error) {
                        dom.forgotError.textContent = error.rawMessage || '操作失败，请稍后重试';
                        throw error;
                    }
                },
                // 其他核心函数...
                // (此处省略了天气、数据同步等未修改的核心函数，以保持简洁)
            };

            // =================================================================
            // == 6. 渲染函数
            // =================================================================
            const render = {
                userActions: () => {
                    dom.userActionsContainer.innerHTML = '';
                    if (state.isLoggedIn) {
                        const userBtn = document.createElement('button');
                        userBtn.id = 'user-btn';
                        userBtn.className = 'header-btn';
                        userBtn.setAttribute('aria-haspopup', 'true');
                        userBtn.setAttribute('aria-expanded', 'false');
            
                        const nickname = state.currentUser.get('nickname') || state.currentUser.getUsername();
                        const initial = nickname.charAt(0).toUpperCase();
            
                        userBtn.innerHTML = `<div class="user-icon-wrapper">${initial}</div><span>${nickname}</span>`;
                        
                        const userMenu = document.createElement('div');
                        userMenu.id = 'user-menu';
                        userMenu.className = 'dropdown-menu';
                        userMenu.innerHTML = `<a href="#" class="dropdown-item" data-action="logout">退出登录</a>`;
                        
                        dom.userActionsContainer.appendChild(userBtn);
                        dom.userActionsContainer.appendChild(userMenu);
                    } else {
                        const loginBtn = document.createElement('button');
                        loginBtn.id = 'login-btn';
                        loginBtn.className = 'header-btn';
                        loginBtn.dataset.action = 'show-auth';
                        loginBtn.innerHTML = `<svg class="header-btn-icon" viewBox="0 0 24 24"><path d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"></path></svg><span>登录 / 注册</span>`;
                        dom.userActionsContainer.appendChild(loginBtn);
                    }
                },
                authModal: () => {
                    if (state.isRegisterMode) {
                        dom.authTitle.textContent = '注册';
                        dom.authSubmitBtn.textContent = '创建账户';
                        dom.authSwitch.innerHTML = '已有账户？<a>立即登录</a>';
                        dom.nicknameGroup.style.display = 'block';
                        dom.forgotPasswordLink.style.display = 'none';
                    } else {
                        dom.authTitle.textContent = '登录';
                        dom.authSubmitBtn.textContent = '登录';
                        dom.authSwitch.innerHTML = '还没有账户？<a>立即注册</a>';
                        dom.nicknameGroup.style.display = 'none';
                        dom.forgotPasswordLink.style.display = 'block';
                    }
                    dom.authError.textContent = '';
                    dom.authForm.reset();
                },
                // (此处省略了其他未修改的渲染函数)
            };
            
            // =================================================================
            // == 7. 事件处理
            // =================================================================
            const handlers = {
                globalClickHandler: (e) => {
                    const dropdownToggle = e.target.closest('[aria-haspopup="true"]');
                    if (dropdownToggle) {
                        e.stopPropagation();
                        // 登录按钮的特殊处理
                        if (dropdownToggle.id === 'login-btn' || dropdownToggle.id === 'user-btn') {
                            const targetModalId = dropdownToggle.id === 'login-btn' ? 'auth-modal' : 'user-menu';
                            const menu = document.getElementById(targetModalId);
                            if (menu) {
                                const isVisible = menu.classList.toggle('visible');
                                dropdownToggle.setAttribute('aria-expanded', isVisible);
                                // 关闭其他所有下拉
                                document.querySelectorAll('.dropdown-menu.visible, .modal-overlay.is-dropdown.visible').forEach(m => {
                                    if (m !== menu) m.classList.remove('visible');
                                });
                            }
                        } else { // 其他下拉菜单
                             const menu = dropdownToggle.parentElement.querySelector('.dropdown-menu');
                             if (menu && !dropdownToggle.disabled) {
                                const wasVisible = menu.classList.contains('visible');
                                utils.closeAllDropdowns();
                                if (!wasVisible) {
                                    menu.classList.add('visible');
                                    dropdownToggle.setAttribute('aria-expanded', 'true');
                                }
                            }
                        }
                        return;
                    }

                    // 点击空白处关闭
                    if (!e.target.closest('.modal-content') && !e.target.closest('[aria-haspopup="true"]')) {
                        utils.closeAllDropdowns();
                    }
                    // 其他点击处理...
                },
                formSubmit: async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitBtn = form.querySelector('[type="submit"]');
                    const originalBtnText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = '处理中...';

                    try {
                        if (form === dom.authForm) {
                            const username = dom.authUsername.value.trim();
                            const password = dom.authPassword.value.trim();
                            if (state.isRegisterMode) {
                                await core.register(username, password);
                            } else {
                                await core.login(username, password);
                            }
                        } else if (form === dom.forgotPasswordForm) {
                            const email = form.querySelector('#forgot-email-input').value.trim();
                            if(email) {
                                await core.handlePasswordReset(email);
                            } else {
                                dom.forgotError.textContent = "请输入邮箱地址。";
                            }
                        }
                        // 其他表单提交...
                    } catch(error) {
                        // 错误已在各自函数中处理并显示在UI上
                        console.log("表单提交捕获到错误，流程已中止。");
                    } finally {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalBtnText;
                        }
                    }
                },
                modalClose: (e) => {
                    const target = e.target;
                    if (target.matches('.modal-overlay') || target.dataset.action === 'close-modal') {
                        const modal = target.closest('.modal-overlay');
                        modal.classList.remove('visible');
                        // 特殊处理：从忘记密码返回登录
                        if(modal === dom.forgotPasswordModal && target.dataset.action === 'close-modal') {
                            state.isRegisterMode = false;
                            render.authModal();
                            dom.authModal.classList.add('visible');
                        }
                    }
                },
                // (其他事件处理器...)
            };

            // =================================================================
            // == 8. 初始化
            // =================================================================
            const init = async () => {
                DOMElementsToCache.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    dom[camelCaseId] = document.getElementById(id);
                });
                
                // 初始化 LeanCloud
                try {
                    if (LEANCLOUD_CONFIG.appId && !LEANCLOUD_CONFIG.appId.startsWith('【')) {
                        AV.init(LEANCLOUD_CONFIG);
                        state.currentUser = AV.User.current();
                        if (state.currentUser) {
                            await state.currentUser.isAuthenticated();
                            state.isLoggedIn = true;
                        }
                    } else {
                        throw new Error("LeanCloud App ID/Key 未配置。");
                    }
                } catch (error) {
                    console.error("LeanCloud 初始化或认证失败:", error);
                    if (error.message.includes("未配置")) utils.showInfoModal("配置错误", "云同步服务未配置，请联系管理员。");
                    AV.User.logOut();
                    state.isLoggedIn = false;
                    state.currentUser = null;
                }
                
                render.userActions();
                // 其他渲染...
                
                // 绑定事件
                document.addEventListener('click', handlers.globalClickHandler);
                document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', handlers.modalClose));
                document.querySelectorAll('form').forEach(f => f.addEventListener('submit', handlers.formSubmit));
                dom.authSwitch.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.isRegisterMode = !state.isRegisterMode;
                    render.authModal();
                });
                dom.forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    utils.closeAllDropdowns();
                    dom.forgotPasswordModal.classList.add('visible');
                    dom.forgotError.textContent = '';
                    dom.forgotPasswordForm.reset();
                });
                // 其他事件绑定...
            };

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
</body>
</html>
