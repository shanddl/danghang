<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>灵动窗</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* * ================================================
         * CSS Variables - 统一的视觉风格变量
         * ================================================
         */
        :root {
            --blue: #8ab4f8;
            --green: #9aa0a6;
            --bg: #17181a;
            --card-bg: #202124;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --border-color: #3c4043;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --hover-shadow-color: rgba(0, 0, 0, 0.35);
            --focus-shadow-color: rgba(138, 180, 248, 0.25);
            --ios-glass-bg: rgba(45, 45, 45, 0.7);
            --text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            --rebound-easing: cubic-bezier(0.34, 1.56, 0.64, 1);
            --nav-item-size: 80px;
        }

        @property --mouse-x {
          syntax: '<number>';
          initial-value: -1;
          inherits: true;
        }

        /* * ================================================
         * 全局和基础样式
         * ================================================
         */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body {
            background: var(--bg);
            color: var(--text-primary);
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite;
            transition: opacity 0.5s ease, background 0.5s ease;
            will-change: background-position;
        }

        body[data-theme="aurora"]::before { background-image: linear-gradient(315deg, #8ab4f8, #34a853, #fbbc05, #ea4335); opacity: 0.2; }
        body[data-theme="sunset"]::before { background-image: linear-gradient(315deg, #f83600, #f9d423, #ff512f, #dd2476); opacity: 0.25; }
        body[data-theme="ocean"]::before { background-image: linear-gradient(315deg, #21d4fd, #b721ff, #08aeea, #2af598); opacity: 0.2; }
        body[data-theme="neon"]::before { background-image: linear-gradient(315deg, #f800b7, #7f00ff, #0072ff, #00bfff); opacity: 0.25; }
        body[data-theme="forest"]::before { background-image: linear-gradient(315deg, #228b22, #556b2f, #8fbc8f, #2e8b57); opacity: 0.2; }
        body[data-theme="cosmic"]::before { background-image: linear-gradient(315deg, #1e0033, #330066, #ffcc00, #cc00ff); opacity: 0.3; }

        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.95) translateY(-5px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-50px); opacity: 0; }
        }
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .nav-item.slide-out { animation: slideOutLeft 0.25s ease-out forwards; }
        .nav-item.slide-in { animation: slideInRight 0.25s ease-out forwards; }


        /* * ================================================
         * 顶部标题栏 (Header)
         * ================================================
         */
        header {
            position: fixed;
            width: 100%;
            top: 0;
            padding: 10px 20px;
            z-index: 100;
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body.theater-mode-active > header {
            opacity: 0 !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            transition-delay: 0s;
            transition-duration: 0.5s;
        }

        .header-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 6px;
            background: transparent;
            border-radius: 26px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0 10px;
        }

        .header-group-left, .header-group-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-btn {
            display: inline-flex; align-items: center; justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 0 16px; height: 40px; border-radius: 20px; cursor: pointer;
            font-size: 14px; white-space: nowrap;
            transition: all 0.2s ease;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .header-btn-icon { width: 18px; height: 18px; margin-right: 8px; fill: currentColor; }
        .ai-btn-container, .theme-btn-container, .engine-btn-container { position: relative; }

        #engine-btn {
            padding: 0;
            width: 40px;
            height: 40px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .header-container:hover #engine-btn {
            opacity: 1;
        }
        #engine-btn img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        #user-actions-container .header-btn#user-btn { 
            padding: 6px;
            background: transparent;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        #user-actions-container .header-btn#login-btn {
            background: transparent;
            padding: 0;
            width: 40px;
            height: 40px;
        }
        #user-actions-container .header-btn#login-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .user-avatar {
            width: 100%; height: 100%; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; margin-right: 0;
            font-weight: 500;
            color: var(--bg);
            background: linear-gradient(45deg, #8ab4f8, #34a853);
        }
        .login-indicator {
            width: 32px; height: 32px; border-radius: 50%; 
            background-color: transparent;
            display: flex; align-items: center; justify-content: center;
        }
        .login-indicator svg {
             width: 20px; height: 20px; 
             fill: var(--text-primary);
        }
        
        .search-container {
            position: relative; 
            display: flex; 
            align-items: center;
            flex-grow: 1;
            justify-content: center;
            min-width: 0;
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: none;
            border-radius: 20px;
            transition: all 0.3s ease;
            margin: 0 8px;
        }
        
        #search-clock {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #E2B376;
            font-size: 16px;
            font-weight: 500;
            pointer-events: none;
            transition: opacity 0.2s ease;
            text-align: center;
            white-space: nowrap;
            z-index: 1;
        }
        #search-clock .day {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .search-container.has-input #search-clock {
            opacity: 0;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            background: var(--ios-glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px;
            min-width: 160px;
            z-index: 120;
            animation: fadeInScaleUp 0.3s var(--rebound-easing) forwards;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .dropdown-menu.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        
        .ai-dropdown-menu, .theme-dropdown-menu, #search-engine-menu {
            transform-origin: top center;
        }
        #user-menu {
            right: 0;
            left: auto;
            transform-origin: top right;
            min-width: 200px;
        }
        .user-info {
            pointer-events: none;
            padding: 10px 14px;
        }
        .user-info-name {
            font-weight: 500;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-info-email {
            font-size: 13px;
            color: var(--text-secondary);
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #add-menu {
            bottom: calc(100% + 8px);
            top: auto;
            left: 50%;
            transform: translateX(-50%);
            transform-origin: bottom center;
        }

        .dropdown-item {
            display: flex; align-items: center; padding: 10px 14px; color: var(--text-primary);
            text-decoration: none; border-radius: 10px; font-size: 15px;
            transition: background-color 0.2s ease, transform 0.2s var(--rebound-easing);
            white-space: nowrap;
        }
        .dropdown-item:active { transform: scale(0.97); transition-duration: 0.1s; }
        .dropdown-item-favicon { width: 16px; height: 16px; margin-right: 10px; border-radius: 4px; }
        .dropdown-item:hover, .dropdown-item.active { background-color: rgba(255, 255, 255, 0.1); }

        #search-form { 
            display: flex; 
            align-items: center; 
            width: 100%;
            position: relative;
        }
        
        #search-scope-btn {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }
        #search-scope-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .search-container:hover #search-scope-btn,
        .search-container.focused #search-scope-btn {
            opacity: 0.7;
        }
        #search-scope-btn:hover {
            opacity: 1;
            background-color: rgba(255,255,255,0.1);
        }

        #search-scope-menu {
            left: 0;
            transform-origin: top left;
        }
        .scope-menu-item .icon {
            width: 16px; height: 16px; margin-right: 10px;
        }
        .scope-menu-item.active {
            font-weight: 500;
            color: var(--blue);
        }

        #active-scope-tag {
            position: absolute;
            left: 42px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(138, 180, 248, 0.2);
            color: var(--blue);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        #active-scope-tag.visible {
            opacity: 1;
        }

        #search-input {
            width: 100%; height: 40px; border: none; padding: 0 45px;
            font-size: 14px; outline: none; background: transparent; color: var(--text-primary);
            text-align: center;
            flex-grow: 1;
            transition: padding-left 0.3s ease;
        }
        #search-input:focus, #search-input:not(:placeholder-shown) {
            text-align: left;
        }
        
        #search-input.has-scope {
            /* Padding is now set dynamically via JS */
        }
        
        .search-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            flex-shrink: 0; width: 40px; height: 40px; background: transparent;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: color 0.2s ease;
            border-radius: 0 20px 20px 0;
        }
        .search-btn svg { width: 18px; height: 18px; }
        .search-btn:hover { color: var(--blue); }

        #search-suggestions-container {
            position: absolute; top: calc(100% + 4px); left: 0; width: 100%;
            z-index: 130;
            padding: 0;
        }
        #suggestion-tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 8px 4px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .suggestion-tab-group {
            display: flex;
            gap: 8px;
        }
        .suggestion-tab {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .suggestion-tab:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .suggestion-tab.active {
            background: var(--blue);
            color: var(--bg);
        }
        #clear-history-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        #clear-history-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #f28b82;
        }
        #suggestion-content {
              max-height: 350px;
              overflow-y: auto;
              padding: 8px;
        }
        .suggestion-item { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .suggestion-item .remove-history-btn {
            background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px;
            border-radius: 50%; display: none; line-height: 1; font-size: 16px;
        }
        .suggestion-item:hover .remove-history-btn { display: block; }
        .suggestion-item .remove-history-btn:hover { background-color: rgba(255, 255, 255, 0.2); color: var(--text-primary); }
        
        #suggestion-content::-webkit-scrollbar { width: 8px; }
        #suggestion-content::-webkit-scrollbar-track { background: transparent; }
        #suggestion-content::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; border: 2px solid var(--card-bg); }
        #suggestion-content::-webkit-scrollbar-thumb:hover { background-color: var(--blue); }

        /* * ================================================
         * 动态船坞 (Dynamic Dock) - [MODIFIED]
         * ================================================
         */
        #bottom-dock-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 110;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 0;
            height: 50px; /* Increased hover area */
            transform: scale(1);
            opacity: 1;
            transition: transform 2.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1), z-index 0s 2.5s;
        }
        
        #dock-container {
            position: absolute;
            bottom: 0;
            left: 50%; 
            background: transparent;
            border-radius: 22px;
            padding: 8px 8px; /* Adjusted padding for alignment */
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: all;
            transform-origin: bottom center;
            width: auto;
            transform: translate(-50%, 100%); /* Hidden state */
            transition: transform 0.5s var(--rebound-easing);
        }

        @keyframes balloon-pop {
            0% { transform: translate(-50%, 0) scale(1, 1); }
            50% { transform: translate(-50%, 0) scale(1.1, 0.9); }
            100% { transform: translate(-50%, 0) scale(1, 1); }
        }

        #bottom-dock-wrapper:hover #dock-container,
        #dock-container.pinned {
            transform: translate(-50%, 0); 
            animation: balloon-pop 0.5s var(--rebound-easing);
        }
        
        #dock-controls {
            display: flex;
            width: 100%;
            justify-content: center;
            align-items: center;
        }
        #dock-category-list {
            display: flex;
            gap: 8px;
            align-items: center;
            overflow-x: auto;
            padding: 2px 4px;
            -ms-overflow-style: none; scrollbar-width: none;
            justify-content: center; 
        }

        #dock-category-list::-webkit-scrollbar { display: none; }
        .dock-category-btn {
            border: none; background: rgba(0,0,0,0.2); color: var(--text-secondary);
            padding: 0 16px; 
            height: 32px;
            border-radius: 16px;
            font-size: 14px; cursor: pointer;
            transition: all 0.2s ease; white-space: nowrap; display: inline-flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }
        .dock-category-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .dock-category-btn.active { background: var(--blue); color: var(--bg); }

        .dock-action-btn {
            border: none; background: rgba(0,0,0,0.2); color: var(--text-primary);
            padding: 0; 
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 14px; cursor: pointer;
            transition: all 0.2s ease; display: inline-flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }
        .dock-action-btn:hover { background: rgba(255,255,255,0.1); }
        .dock-action-btn.active { background: var(--blue); color: var(--bg) !important; }
        .add-btn { font-size: 20px; }
        #pin-btn svg { width: 18px; height: 18px; fill: var(--text-secondary); transition: fill 0.2s ease; }
        #pin-btn.pinned svg { fill: var(--blue); }

        #content-wrapper {
            flex-grow: 1; position: relative; height: 100vh;
            transform: scale(1);
            opacity: 1;
            transition: transform 2.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        main {
            padding: 80px 16px 150px;
            overflow-y: auto; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Nav Grids */
        #nav-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            padding: 10px;
            transition: outline 0.2s ease;
        }

        .nav-item {
            position: relative; display: flex; align-items: center; text-decoration: none;
            color: var(--text-primary); background: transparent;
            opacity: 1;
            transition: all 0.3s var(--rebound-easing);
            -webkit-user-select: none; user-select: none; will-change: transform, opacity;
            cursor: pointer;
        }

        .nav-item:hover .nav-icon-wrapper {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        .nav-item:active .nav-icon-wrapper { transform: scale(0.95); transition-duration: 0.1s; }

        .nav-item {
            flex-direction: column; justify-content: center; 
            padding: 8px;
            border-radius: 24px; height: auto; width: auto;
        }
        .nav-icon-wrapper {
            width: calc(var(--nav-item-size) * 0.75);
            height: calc(var(--nav-item-size) * 0.75);
            border-radius: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s var(--rebound-easing);
            flex-shrink: 0;
            pointer-events: none;
        }
        .nav-icon-wrapper img {
            width: calc(var(--nav-item-size) * 0.45); height: calc(var(--nav-item-size) * 0.45);
            transition: all 0.2s ease; border-radius: 8px;
        }
        .nav-label {
            font-size: calc(var(--nav-item-size) * 0.15); text-shadow: var(--text-shadow);
            transition: all 0.2s ease; margin-left: 0;
            pointer-events: none;
        }
        
        body.shape-h-capsule #nav-grid .nav-item {
            flex-direction: row; justify-content: flex-start; padding: 8px 16px 8px 12px;
            height: var(--nav-item-size); border-radius: 60px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body.shape-h-capsule #nav-grid .nav-icon-wrapper {
            margin-bottom: 0; width: calc(var(--nav-item-size) * 0.7);
            height: calc(var(--nav-item-size) * 0.7); border-radius: 50%;
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: none;
        }
        body.shape-h-capsule #nav-grid .nav-icon-wrapper img {
            width: calc(var(--nav-item-size) * 0.4); height: calc(var(--nav-item-size) * 0.4);
        }
        body.shape-h-capsule #nav-grid .nav-label {
            margin-left: 15px; font-size: calc(var(--nav-item-size) * 0.25);
        }
        body.shape-h-capsule #nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(calc(var(--nav-item-size) * 2.5), 1fr));
        }

        body.shape-circle .nav-icon-wrapper {
            border-radius: 50%;
        }
        body.shape-circle .nav-icon-wrapper img {
            border-radius: 50%;
        }

        /* * ================================================
         * 模态框 (Modal) & 其他
         * ================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        /* [FIXED] Ensure confirm modal is on top */
        #confirm-modal {
            z-index: 1001;
        }
        .modal-overlay.visible {
            opacity: 1; visibility: visible; transition-delay: 0s;
        }
        .modal-content {
            background: var(--card-bg); padding: 24px; border-radius: 16px;
            width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95); transition: transform 0.3s var(--rebound-easing);
            display: flex;
            flex-direction: column;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 24px;
            color: var(--text-primary);
            text-align: center;
            flex-shrink: 0;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-secondary);
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; background: var(--bg); color: var(--text-primary);
            font-size: 16px; transition: border-color 0.2s;
            font-family: inherit;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--blue);
        }
        .form-group input.new-category-input { margin-top: 10px; }
        
        .url-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .url-input-group input {
            flex-grow: 1;
        }
        .fetch-icon-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        .fetch-icon-btn:hover {
            border-color: var(--blue);
            color: var(--blue);
        }
        .icon-preview-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .icon-preview {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background-color: rgba(255,255,255,0.1);
            object-fit: contain;
        }


        .modal-actions {
            display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;
            flex-shrink: 0;
        }
        .modal-btn {
            padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer;
            font-size: 15px; font-weight: 500; transition: all 0.2s;
        }
        .modal-btn.cancel {
            background-color: transparent; color: var(--text-secondary);
        }
        .modal-btn.cancel:hover { background-color: rgba(255,255,255,0.05); }
        .modal-btn.save { background-color: var(--blue); color: var(--bg); }
        .modal-btn.save:hover { opacity: 0.85; }

        #auth-modal .modal-content, #forgot-password-modal .modal-content, #custom-alert-modal .modal-content {
            background: #292a2d;
            border-radius: 12px;
            padding: 32px;
            width: 90%;
            max-width: 360px;
        }
        #auth-modal h3, #forgot-password-modal h3, #custom-alert-modal h3 {
            font-weight: 500;
            font-size: 20px;
            margin-bottom: 24px;
        }
        #auth-form, #forgot-password-form {
            width: 100%;
        }
        .auth-form-group { margin-bottom: 16px; }
        .auth-form-group input {
            width: 100%;
            padding: 12px 14px;
            background: #3c4043;
            border: 1px solid #5f6368;
            border-radius: 10px;
            font-size: 15px;
            text-align: left;
            color: var(--text-primary);
        }
        .auth-form-group input::placeholder {
            color: #9aa0a6;
        }
        .auth-form-group input:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px var(--focus-shadow-color);
        }
        .auth-actions { margin-top: 24px; }
        .auth-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            background-color: var(--blue);
            color: #202124;
            font-size: 16px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-btn:hover { opacity: 0.9; }
        .auth-btn:active { transform: scale(0.98); }
        .auth-error-message {
            color: #f28b82;
            font-size: 14px;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 15px;
            min-height: 1.2em;
        }
        .auth-switch-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .auth-switch-link a {
            color: var(--blue);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }
        .auth-switch-link a:hover { text-decoration: underline; }

        #forgot-password-link {
            margin-top: 10px;
            font-size: 13px;
        }
        
        #manage-scopes-modal .modal-content, #manage-engines-modal .modal-content {
            max-width: 550px;
            max-height: 80vh;
        }
        .modal-scroll-content {
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }
        .modal-scroll-content::-webkit-scrollbar, #scope-list::-webkit-scrollbar, #engine-list::-webkit-scrollbar { width: 8px; }
        .modal-scroll-content::-webkit-scrollbar-track, #scope-list::-webkit-scrollbar-track, #engine-list::-webkit-scrollbar-track { background: transparent; }
        .modal-scroll-content::-webkit-scrollbar-thumb, #scope-list::-webkit-scrollbar-thumb, #engine-list::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; border: 2px solid var(--card-bg); }
        .modal-scroll-content::-webkit-scrollbar-thumb:hover, #scope-list::-webkit-scrollbar-thumb:hover, #engine-list::-webkit-scrollbar-thumb:hover { background-color: var(--blue); }

        #scope-list, #engine-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .scope-list-item, .engine-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            background-color: var(--bg);
            margin-bottom: 8px;
        }
        .scope-list-item-name, .engine-list-item-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .engine-list-item-name img {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .scope-list-item-actions, .engine-list-item-actions {
            display: flex;
            gap: 8px;
        }
        .scope-list-item-actions button, .engine-list-item-actions button {
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; padding: 4px 8px; font-size: 14px;
            border-radius: 6px;
        }
        .scope-list-item-actions button:hover, .engine-list-item-actions button:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .scope-list-item-actions button.delete:hover, .engine-list-item-actions button.delete:hover {
            color: #f28b82;
        }
        #manage-scopes-form-container, #manage-engines-form-container {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        #manage-scopes-form-container h4, #manage-engines-form-container h4 {
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        #scope-custom-date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }


        .hidden { display: none !important; }

        /* * ================================================
         * 自定义布局面板 (Customize Panel) - [FIXED]
         * ================================================
         */
        #size-slider-panel {
            position: fixed; left: 30px; top: 50%;
            transform: translate(-200%, -50%); z-index: 110;
            background: var(--ios-glass-bg);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            padding: 20px 12px; border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            transition: transform 0.6s var(--rebound-easing);
            display: flex; flex-direction: column; align-items: center; gap: 16px;
            width: auto; height: auto; max-height: 500px; will-change: transform;
        }
        #size-slider-panel.visible { transform: translate(0, -50%); }

        .customize-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .customize-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .customize-btn svg {
            width: 22px;
            height: 22px;
            fill: var(--text-secondary);
            transition: fill 0.2s ease;
        }
        .customize-btn:hover svg {
            fill: var(--text-primary);
        }

        #size-slider-panel .shape-select-container { position: relative; }
        .slider-container {
            width: 24px; height: 180px; display: flex; align-items: center; justify-content: center;
        }
        #size-slider {
            -webkit-appearance: slider-vertical; width: 8px; height: 100%;
            background: rgba(255,255,255,0.2); border-radius: 5px; outline: none;
            transition: opacity 0.2s;
        }
        #size-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px;
            background: #fff; cursor: pointer; border-radius: 50%;
            border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #size-slider::-moz-range-thumb {
            width: 24px; height: 24px; background: #fff; cursor: pointer;
            border-radius: 50%; border: 1px solid var(--border-color);
        }
        #shape-select-menu {
            top: 0; left: calc(100% + 8px); transform: none; transform-origin: top left;
        }

        #search-results-container {
            padding: 0 16px;
        }
        #search-stats {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
            padding-top: 6px;
        }
        .search-result-item {
            margin-bottom: 28px;
        }
        .search-result-header {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .search-result-favicon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .search-result-content {
            display: flex;
            flex-direction: column;
        }
        .search-result-url {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.3;
        }
        .search-result-url cite {
            font-style: normal;
            color: var(--text-secondary);
        }
        .search-result-title {
            font-size: 20px;
            line-height: 1.3;
            font-weight: 400;
            margin: 0;
        }
        .search-result-title a {
            color: var(--blue);
            text-decoration: none;
        }
        .search-result-title a:hover {
            text-decoration: underline;
        }
        .search-result-description {
            color: var(--text-secondary);
            line-height: 1.58;
            font-size: 14px;
            margin-top: 2px;
        }

        #context-menu, #main-context-menu {
            position: fixed;
            z-index: 10000;
            width: 180px;
            background: var(--ios-glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px;
            display: none;
        }
        #context-menu.visible, #main-context-menu.visible {
            display: block;
            animation: fadeInScaleUp 0.2s var(--rebound-easing) forwards;
        }
        #context-menu.opens-up {
            transform-origin: bottom left;
        }
        .context-menu-item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .context-menu-item.delete {
            color: #f28b82;
        }
        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 8px;
        }

        /* * ================================================
         * 剧场模式 (Theater Mode)
         * ================================================
         */
        #wallpaper-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50; /* Behind main content */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transform: scale(1.05);
            visibility: hidden;
            transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1), transform 2.5s cubic-bezier(0.4, 0, 0.2, 1);
            --wallpaper-url: ''; /* 新增：用于交叉淡入的CSS变量 */
        }
        #wallpaper-container.visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }

        /* 新增：用于交叉淡入效果的伪元素 */
        #wallpaper-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--wallpaper-url-old);
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.75s ease-in-out;
            z-index: -1;
        }
        #wallpaper-container.is-loading::before {
            opacity: 1;
        }


        body.theater-mode-active > #content-wrapper,
        body.theater-mode-active > #bottom-dock-wrapper {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            transition-delay: 0s;
            transition-duration: 0.5s;
        }
        body.theater-mode-active > #bottom-dock-wrapper {
            z-index: 40; /* Lower than wallpaper container */
        }
        
        #wallpaper-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 24px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s;
            z-index: 52;
        }

        #wallpaper-container.controls-visible #wallpaper-controls,
        #wallpaper-gallery-panel.visible ~ #wallpaper-controls {
            opacity: 1;
            visibility: visible;
        }
        
        /* Hide controls when gallery is open */
        #wallpaper-gallery-panel.visible ~ #wallpaper-controls {
            opacity: 0;
            visibility: hidden;
        }


        .wallpaper-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .wallpaper-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .wallpaper-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        /* 新增：水印按钮激活状态 */
        .wallpaper-btn#toggle-watermark-btn.active {
            background-color: rgba(138, 180, 248, 0.3);
            color: var(--blue);
        }

        #wallpaper-info {
            position: absolute;
            bottom: 20px;
            right: 20px; /* 改为右下角 */
            color: white;
            font-size: 13px;
            background-color: rgba(0,0,0,0.3);
            padding: 4px 10px;
            border-radius: 8px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            max-width: 50%;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 52;
            text-align: right;
            visibility: hidden;
        }
        #wallpaper-container.visible #wallpaper-info.visible {
            opacity: 1;
            visibility: visible;
        }

        .wallpaper-category-container {
            position: relative;
        }
        
        #wallpaper-gallery-trigger {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            cursor: pointer;
            z-index: 53;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #wallpaper-gallery-trigger::after {
            content: '';
            width: 36px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #wallpaper-gallery-trigger:hover::after {
            opacity: 1;
        }
        
        #wallpaper-gallery-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--ios-glass-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            z-index: 51;
            overflow-y: auto;
            transform: translateY(-100%);
            transition: transform 0.6s var(--rebound-easing);
            will-change: transform;
        }
        #wallpaper-gallery-panel.visible {
            transform: translateY(0);
        }
        #wallpaper-gallery-categories-container {
            position: sticky;
            top: 0;
            padding: 80px 20px 15px;
            background: rgba(29, 30, 32, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 52;
            display: flex;
            gap: 12px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #wallpaper-gallery-categories-container::-webkit-scrollbar {
            display: none;
        }

        .wallpaper-gallery-category-btn {
            border: none;
            background: rgba(0,0,0,0.2);
            color: var(--text-secondary);
            padding: 0 16px;
            height: 32px;
            border-radius: 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .wallpaper-gallery-category-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .wallpaper-gallery-category-btn.active {
            background: var(--blue);
            color: var(--bg);
            font-weight: 500;
        }
        #wallpaper-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 20px 40px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .wallpaper-gallery-item {
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s var(--rebound-easing), box-shadow 0.2s ease;
            position: relative;
            background-color: var(--card-bg);
            aspect-ratio: 16 / 10;
        }
        .wallpaper-gallery-item:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .wallpaper-gallery-item img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }
        
        #gallery-loader {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            grid-column: 1 / -1; /* Span all columns */
        }

        /* * ================================================
         * 移动端响应式布局 (Mobile Responsiveness)
         * ================================================
         */
        @media (max-width: 768px) {
            :root {
                --nav-item-size: 70px;
            }
            main {
                padding: 80px 10px 120px;
            }
            header {
                padding: 10px;
            }
            
            #nav-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            #bottom-dock-wrapper {
                padding-bottom: 5px;
            }
            #dock-container {
                padding: 8px;
                border-radius: 22px;
            }
            .dock-category-btn {
                height: 32px;
                padding: 0 14px;
                font-size: 13px;
            }
            .dock-action-btn {
                width: 32px;
                height: 32px;
            }
            #search-container {
                flex-grow: 1;
                margin: 0 8px;
            }
            .header-group-left .header-btn span,
            .header-group-right .header-btn span {
                display: none;
            }
            .header-group-left .header-btn-icon,
            .header-group-right .header-btn-icon {
                margin-right: 0;
            }
            #wallpaper-controls {
                gap: 8px;
                padding: 6px 10px;
            }
            #wallpaper-info {
                font-size: 12px;
            }
            #wallpaper-gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
                padding: 20px 10px 20px;
            }
            #wallpaper-gallery-categories-container {
                padding: 70px 10px 15px;
            }
        }

        @media (max-width: 480px) {
             :root {
                --nav-item-size: 65px;
            }
            #nav-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .header-btn span {
                display: none;
            }
            .header-btn-icon {
                margin-right: 0;
            }
            #user-actions-container .header-btn#user-btn .user-avatar {
                margin-right: 0;
            }
             #wallpaper-gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

    </style>
</head>
<body data-theme="aurora">

    <header>
        <div class="header-container">
            <div class="header-content">
                 <div class="header-group-left">
                    <div class="engine-btn-container">
                        <button id="engine-btn" class="header-btn" aria-haspopup="true" aria-expanded="false" title="切换搜索引擎">
                            <img src="https://www.google.com/favicon.ico" alt="Current Search Engine">
                        </button>
                        <div id="search-engine-menu" class="dropdown-menu"></div>
                    </div>
                     <div class="ai-btn-container">
                         <button id="ai-btn" class="header-btn ai-btn" aria-haspopup="true" aria-expanded="false">
                             <svg class="header-btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5l1.06 2.16L15.5 5.5l-2.16 1.06L12 8.5l-1.06-2.16L8.5 5.5l2.16-1.06z M5 10l1.5 3L8 14.5l-1.5 1.5-1.5 3-1.5-3L2 14.5l1.5-1.5z M19 10l1.5 3L22 14.5l-1.5 1.5-1.5 3-1.5-3L16 14.5l1.5-1.5z"></path></svg>
                             <span>AI</span>
                         </button>
                         <div id="ai-dropdown-menu" class="dropdown-menu ai-dropdown-menu" role="menu"></div>
                     </div>
                     <div class="theme-btn-container">
                          <button id="theme-btn" class="header-btn theme-btn" aria-haspopup="true" aria-expanded="false">
                             <svg class="header-btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                             <span>主题</span>
                         </button>
                         <div id="theme-dropdown-menu" class="dropdown-menu theme-dropdown-menu" role="menu"></div>
                     </div>
                 </div>

                 <div id="search-container" class="search-container">
                     <form id="search-form" role="search">
                         <div class="search-scope-container" style="position: relative;">
                             <button type="button" id="search-scope-btn" aria-haspopup="true" aria-expanded="false" title="切换搜索范围 (Tab)">
                                 <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"></path></svg>
                             </button>
                             <div id="search-scope-menu" class="dropdown-menu"></div>
                         </div>
                         <div id="active-scope-tag"></div>
                         <input id="search-input" placeholder=" " autocomplete="off">
                         <button type="submit" class="search-btn" aria-label="搜索">
                             <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                         </button>
                     </form>
                     <div id="search-clock"></div>
                     <!-- [FIXED] Added missing search suggestions container -->
                     <div id="search-suggestions-container" class="dropdown-menu">
                        <div id="suggestion-tabs">
                            <div class="suggestion-tab-group">
                                <button class="suggestion-tab active" data-type="suggestion">搜索建议</button>
                                <button class="suggestion-tab" data-type="history">历史记录</button>
                            </div>
                            <button id="clear-history-btn" class="hidden">清空</button>
                        </div>
                        <div id="suggestion-content"></div>
                    </div>
                 </div>

                 <div class="header-group-right">
                     <div id="user-actions-container"></div>
                 </div>
            </div>
        </div>
    </header>

    <div id="content-wrapper">
        <main id="main-content">
            <div id="nav-grid" class="nav-grid">
            </div>
            <div id="search-results-container" class="hidden">
                <div id="search-stats"></div>
                <div id="search-results-list"></div>
            </div>
        </main>
    </div>

    <div id="bottom-dock-wrapper">
        <div id="dock-container">
            <div id="dock-controls">
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay" role="alertdialog" aria-modal="true">
        <div class="modal-content">
            <h3 id="confirm-modal-title">请确认</h3>
            <p id="confirm-modal-message" style="margin: 20px 0; color: var(--text-secondary); white-space: pre-wrap;"></p>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" data-action="close-modal">取消</button>
                <button type="button" id="confirm-modal-btn" class="modal-btn save">确认</button>
            </div>
        </div>
    </div>
    <div id="add-category-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>添加新分类</h3>
            <form id="add-category-form">
                <div class="form-group">
                    <label for="category-name">分类名称</label>
                    <input type="text" id="category-name" required placeholder="例如: 生活">
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-action="close-modal">取消</button>
                    <button type="submit" class="modal-btn save">保存</button>
                </div>
            </form>
        </div>
    </div>
    <div id="edit-category-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>编辑分类</h3>
            <form id="edit-category-form">
                <input type="hidden" id="edit-category-old-name">
                <div class="form-group">
                    <label for="edit-category-name">新分类名称</label>
                    <input type="text" id="edit-category-name" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-action="close-modal">取消</button>
                    <button type="submit" class="modal-btn save">保存更改</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-site-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>添加新网站</h3>
            <form id="add-site-form">
                <input type="hidden" id="site-icon-hidden">
                <div class="form-group">
                    <label for="site-name">网站名称</label>
                    <input type="text" id="site-name" required placeholder="例如: 谷歌">
                </div>
                <div class="form-group">
                    <label for="site-url">网站地址</label>
                    <div class="url-input-group">
                        <input type="text" id="site-url" required placeholder="google.com">
                        <button type="button" class="fetch-icon-btn" data-action="fetch-icon-bqb">获取图标</button>
                    </div>
                </div>
                <div class="icon-preview-container">
                    <img id="add-site-icon-preview" class="icon-preview" src="https://placehold.co/32x32/f0f0f0/000000?text=?">
                    <span>图标预览</span>
                </div>
                 <div class="form-group">
                    <label for="site-category-select">网站分类</label>
                    <select id="site-category-select"></select>
                    <input type="text" id="site-category-new" class="new-category-input hidden" placeholder="输入新分类名称">
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-action="close-modal">取消</button>
                    <button type="submit" class="modal-btn save">保存</button>
                </div>
            </form>
        </div>
    </div>
    <div id="edit-site-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>编辑网站</h3>
            <form id="edit-site-form">
                <input type="hidden" id="edit-site-index">
                <input type="hidden" id="edit-site-icon-hidden">
                <div class="form-group">
                    <label for="edit-site-name">网站名称</label>
                    <input type="text" id="edit-site-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-site-url">网站地址</label>
                     <div class="url-input-group">
                        <input type="text" id="edit-site-url" required>
                        <button type="button" class="fetch-icon-btn" data-action="fetch-icon-bqb">获取图标</button>
                    </div>
                </div>
                <div class="icon-preview-container">
                    <img id="edit-site-icon-preview" class="icon-preview" src="https://placehold.co/32x32/f0f0f0/000000?text=?">
                    <span>图标预览</span>
                </div>
                 <div class="form-group">
                    <label for="edit-site-category-select">网站分类</label>
                    <select id="edit-site-category-select"></select>
                    <input type="text" id="edit-site-category-new" class="new-category-input hidden" placeholder="输入新分类名称">
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-action="close-modal">取消</button>
                    <button type="submit" class="modal-btn save">保存更改</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="manage-scopes-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>管理搜索范围</h3>
            <div class="modal-scroll-content">
                <ul id="scope-list">
                </ul>
                <div id="manage-scopes-form-container">
                    <h4 id="scope-form-title">创建新范围</h4>
                    <form id="manage-scopes-form">
                        <input type="hidden" id="scope-edit-id">
                        <div class="form-group">
                            <label for="scope-name">范围名称</label>
                            <input type="text" id="scope-name" placeholder="例如: 技术资料库" required>
                        </div>
                        <div class="form-group">
                            <label for="scope-sites">指定网站 (每行一个)</label>
                            <textarea id="scope-sites" placeholder="github.com&#10;stackoverflow.com"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="scope-filetype">指定文件类型 (可选)</label>
                            <input type="text" id="scope-filetype" placeholder="例如: pdf, docx">
                        </div>
                        <div class="form-group">
                            <label for="scope-intitle">标题包含 (可选)</label>
                            <input type="text" id="scope-intitle" placeholder="例如: 教程">
                        </div>
                        <div class="form-group">
                            <label for="scope-intext">正文包含 (可选)</label>
                            <input type="text" id="scope-intext" placeholder="例如: 快速入门">
                        </div>
                        <div class="form-group">
                            <label for="scope-exact-phrase">精确匹配短语 (可选)</label>
                            <input type="text" id="scope-exact-phrase" placeholder="例如: a bird in the hand">
                        </div>
                        <div class="form-group">
                            <label for="scope-exclude-words">排除的词语 (可选, 用空格隔开)</label>
                            <input type="text" id="scope-exclude-words" placeholder="例如: job招聘">
                        </div>
                        <div class="form-group">
                            <label for="scope-time-range">时间范围 (可选)</label>
                            <select id="scope-time-range">
                                <option value="any">任何时间</option>
                                <option value="day">过去24小时</option>
                                <option value="week">过去一周</option>
                                <option value="month">过去一月</option>
                                <option value="year">过去一年</option>
                                <option value="after">在此之后</option>
                                <option value="before">在此之前</option>
                                <option value="custom">自定义范围</option>
                            </select>
                        </div>
                        <div id="scope-custom-date-range" class="form-group hidden">
                            <div id="start-date-container" class="form-group">
                                <label for="scope-start-date">开始日期</label>
                                <input type="date" id="scope-start-date" aria-label="开始日期">
                            </div>
                            <div id="end-date-container" class="form-group">
                                <label for="scope-end-date">结束日期</label>
                                <input type="date" id="scope-end-date" aria-label="结束日期">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="scope-form-cancel" class="modal-btn cancel hidden">取消编辑</button>
                <button type="submit" form="manage-scopes-form" class="modal-btn save">保存范围</button>
            </div>
        </div>
    </div>

    <div id="manage-engines-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>管理搜索引擎</h3>
            <div class="modal-scroll-content">
                <ul id="engine-list">
                </ul>
                <div id="manage-engines-form-container">
                    <h4 id="engine-form-title">添加新引擎</h4>
                    <form id="manage-engines-form">
                        <input type="hidden" id="engine-edit-id">
                        <div class="form-group">
                            <label for="engine-name">引擎名称</label>
                            <input type="text" id="engine-name" placeholder="例如: DuckDuckGo" required>
                        </div>
                        <div class="form-group">
                            <label for="engine-url">搜索网址 (必须包含 {query})</label>
                            <input type="text" id="engine-url" placeholder="https://duckduckgo.com/?q={query}" required>
                        </div>
                        <div class="form-group">
                            <label for="engine-icon-url">图标地址 (可选)</label>
                             <div class="url-input-group">
                                <input type="text" id="engine-icon-url" placeholder="https://duckduckgo.com/favicon.ico">
                                <button type="button" class="fetch-icon-btn" data-action="fetch-engine-icon">获取图标</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="engine-form-cancel" class="modal-btn cancel hidden">取消编辑</button>
                <button type="submit" form="manage-engines-form" class="modal-btn save">保存引擎</button>
            </div>
        </div>
    </div>


    <div id="auth-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3 id="auth-title">登录</h3>
            <form id="auth-form">
                 <div class="auth-form-group" id="nickname-group">
                    <input type="text" id="auth-nickname" placeholder="昵称" autocomplete="nickname">
                </div>
                <div class="auth-form-group">
                    <input type="email" id="auth-email" placeholder="邮箱" required autocomplete="email">
                </div>
                <div class="auth-form-group">
                    <input type="password" id="auth-password" placeholder="密码" required autocomplete="current-password">
                </div>
                <div id="auth-error" class="auth-error-message"></div>
                <div class="auth-actions">
                    <button id="auth-submit-btn" type="submit" class="auth-btn">登录</button>
                </div>
            </form>
            <p id="auth-switch" class="auth-switch-link">还没有账户？<a>立即注册</a></p>
            <p id="forgot-password-link" class="auth-switch-link"><a>忘记密码？</a></p>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h3>重设密码</h3>
            <form id="forgot-password-form">
                <div class="auth-form-group">
                    <input type="email" id="forgot-email-input" placeholder="请输入您注册时使用的邮箱" required autocomplete="email">
                </div>
                <div class="auth-actions">
                    <button id="forgot-submit-btn" type="submit" class="auth-btn">发送重设邮件</button>
                </div>
            </form>
             <div class="modal-actions" style="justify-content: center; margin-top: 15px;">
                <button type="button" class="modal-btn cancel" data-action="close-modal">返回</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="modal-overlay" role="alertdialog" aria-modal="true">
        <div class="modal-content">
            <h3 id="custom-alert-title">提示</h3>
            <p id="custom-alert-message" style="margin: 20px 0; color: var(--text-secondary); text-align: center; white-space: pre-wrap;"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button type="button" class="modal-btn save" data-action="close-modal">确认</button>
            </div>
        </div>
    </div>

    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <div id="size-slider-panel">
        <button id="increase-size-btn" class="customize-btn" title="增大图标">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
        </button>
        <div class="slider-container">
            <input type="range" id="size-slider" min="50" max="160" value="80" aria-label="调整图标大小">
        </div>
        <button id="decrease-size-btn" class="customize-btn" title="减小图标">
            <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"></path></svg>
        </button>
        <div class="shape-select-container">
            <button id="shape-select-btn" class="customize-btn" aria-haspopup="true" aria-expanded="false">
                <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"></path></svg>
            </button>
            <div id="shape-select-menu" class="dropdown-menu" role="menu"></div>
        </div>
    </div>

    <div id="context-menu" class="dropdown-menu">
        <div class="context-menu-item" data-action="edit-site">编辑</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item delete" data-action="delete-site">删除</div>
    </div>
    <div id="main-context-menu" class="dropdown-menu">
        <div class="context-menu-item" data-action="add-site">添加网站</div>
        <div class="context-menu-item" data-action="add-category">添加分类</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="toggle-customize-panel">自定义布局</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="refresh-page">刷新</div>
    </div>

    <div id="wallpaper-container">
        <div id="wallpaper-gallery-trigger"></div>
        <div id="wallpaper-gallery-panel">
            <div id="wallpaper-gallery-categories-container"></div>
            <div id="wallpaper-gallery-grid"></div>
            <div id="gallery-loader" class="hidden">正在加载更多...</div>
        </div>
        <div id="wallpaper-info"></div>
        <div id="wallpaper-controls">
            <button id="prev-wallpaper-btn" class="wallpaper-btn" title="上一张">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
            </button>
            <button id="play-pause-wallpaper-btn" class="wallpaper-btn" title="播放/暂停">
                <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <svg id="pause-icon" viewBox="0 0 24 24" class="hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
            </button>
            <button id="next-wallpaper-btn" class="wallpaper-btn" title="下一张">
                <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"></path></svg>
            </button>
            <!-- 新增：水印开关按钮 -->
            <button id="toggle-watermark-btn" class="wallpaper-btn" title="显示/隐藏信息">
                <svg viewBox="0 0 24 24"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
            </button>
            <button id="download-wallpaper-btn" class="wallpaper-btn" title="下载">
                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
            </button>
        </div>
    </div>


    <script>
        (() => {
            'use strict';

            // =================================================================
            // Supabase 配置 (已为您填好)
            // =================================================================
            const SUPABASE_CONFIG = {
                url: "https://efksqykktzdvxpflivhb.supabase.co", 
                anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVma3NxeWtrdHpkdnhwZmxpdmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDMxNTksImV4cCI6MjA3MTIxOTE1OX0.mkgVqKBUQRZmtTwEadCiZPRW7KOKIvWYjhJo6AwyOiU",
            };
            
            // 全局 Supabase 客户端实例
            let supabase = null;
            if (SUPABASE_CONFIG.url && !SUPABASE_CONFIG.url.startsWith('【')) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            } else {
                console.error("错误：Supabase URL / Anon Key 未配置。请在代码中填写您的项目凭据。");
            }

            // =================================================================
            // 静态配置和常量
            // =================================================================
            const STATIC_CONFIG = {
                AI_TOOLS: {
                    'kimi':    { name: 'Kimi Chat', icon: 'https://kimi.moonshot.cn/favicon.ico', homeUrl: 'https://kimi.moonshot.cn/' },
                    'dangbei': { name: '当贝AI', icon: 'https://ai.dangbei.com/favicon.ico', homeUrl: 'https://ai.dangbei.com/chat' },
                    'grok':    { name: 'Grok', icon: 'https://grok.dairoot.cn/favicon.ico', homeUrl: 'https://grok.dairoot.cn/' }
                },
                DEFAULT_USER_DATA: {
                    navItems: [
                        { name: '哔哩哔哩', url: 'https://www.bilibili.com', icon: 'https://www.bilibili.com/favicon.ico', category: '社交' },
                        { name: '抖音', url: 'https://www.douyin.com', icon: 'https://www.douyin.com/favicon.ico', category: '社交' },
                        { name: '微博', url: 'https://www.weibo.com', icon: 'https://weibo.com/favicon.ico', category: '社交' },
                        { name: '知乎', url: 'https://www.zhihu.com', icon: 'https://www.zhihu.com/favicon.ico', category: '社交' },
                        { name: '淘宝', url: 'https://www.taobao.com', icon: 'https://www.taobao.com/favicon.ico', category: '购物' },
                        { name: '京东', url: 'https://www.jd.com', icon: 'https://www.jd.com/favicon.ico', category: '购物' },
                    ],
                    navCategories: ['社交', '购物', '工具'],
                    navShape: 'square',
                    navSize: 80,
                    searchHistory: [],
                    searchScopes: [], 
                    searchEngines: [
                        { id: 'engine_ddns', name: 'DDNS-IP', url: 'https://so.ddns-ip.net/?q={query}', icon: 'https://so.ddns-ip.net/favicon.ico' },
                        { id: 'engine_google', name: 'Google', url: 'https://www.google.com/search?q={query}', icon: 'https://www.google.com/favicon.ico' },
                        { id: 'engine_bing', name: 'Bing', url: 'https://www.bing.com/search?q={query}', icon: 'https://www.bing.com/favicon.ico' },
                        { id: 'engine_baidu', name: '百度', url: 'https://www.baidu.com/s?wd={query}', icon: 'https://www.baidu.com/favicon.ico' },
                        { id: 'engine_sogou', name: '搜狗', url: 'https://www.sogou.com/web?query={query}', icon: 'https://www.sogou.com/favicon.ico' }
                    ],
                    activeSearchEngineId: 'engine_ddns',
                    theme: 'auto', 
                    isDockPinned: false, 
                    showWatermark: true,
                },
                THEMES: ['aurora', 'sunset', 'ocean', 'neon', 'forest', 'cosmic'],
                WALLPAPER_SOURCES: {
                    'bing': { name: '必应每日', type: 'bing_api' },
                    'unsplash_landscape': { name: '随机风景', type: 'unsplash', url: 'https://source.unsplash.com/1920x1080/?landscape,nature' },
                    'unsplash_city': { name: '随机城市', type: 'unsplash', url: 'https://source.unsplash.com/1920x1080/?city,architecture' },
                    'unsplash_tech': { name: '随机科技', type: 'unsplash', url: 'https://source.unsplash.com/1920x1080/?technology,abstract' },
                    'unsplash_animal': { name: '随机动物', type: 'unsplash', url: 'https://source.unsplash.com/1920x1080/?animal,wildlife' },
                    'btstu_fengjing': { name: '风景壁纸', type: 'btstu', url: 'https://api.btstu.cn/sjbz/api.php?lx=fengjing&format=json' },
                    'btstu_dongman': { name: '动漫壁纸', type: 'btstu', url: 'https://api.btstu.cn/sjbz/api.php?lx=dongman&format=json' }
                },
                CONSTANTS: {
                    ALL_CATEGORIES: '全部',
                    NEW_CATEGORY_VALUE: '--new--',
                    STORAGE_KEY: '灵动窗用户数据',
                    WALLPAPERS_PER_PAGE: 30,
                    DEFAULT_SCOPE_ID: 'default-web-search'
                }
            };

            // =================================================================
            // 应用状态管理
            // =================================================================
            const state = {
                themeInterval: null,
                currentThemeIndex: 0,
                confirmCallback: null,
                isLoggedIn: false,
                isRegisterMode: false,
                currentUser: null,
                activeSuggestionIndex: -1,
                suggestionViewMode: 'suggestion',
                draggedItem: null,
                contextMenuItem: null,
                isTheaterMode: false,
                currentWallpaperCategory: 'bing',
                activeWallpaperGalleryCategory: 'all',
                currentWallpaperIndex: 0,
                wallpaperCache: {}, 
                nextWallpaper: new Image(),
                isWallpaperLoading: false,
                galleryUrlCache: new Set(),
                isSlideshowPlaying: false,
                slideshowInterval: null,
                controlsTimeout: null,
                isLoadingMoreWallpapers: false,
                currentWallpaperPage: 1,
                userData: JSON.parse(JSON.stringify(STATIC_CONFIG.DEFAULT_USER_DATA)),
                activeSearchScopeId: STATIC_CONFIG.CONSTANTS.DEFAULT_SCOPE_ID,
            };

            // =================================================================
            // DOM 元素缓存
            // =================================================================
            const dom = {};
            const DOMElementsToCache = [
                'body', 'main-content', 'header',
                'bottom-dock-wrapper', 'dock-container', 'dock-controls',
                'nav-grid', 'add-site-modal',
                'add-site-form', 'edit-site-modal', 'edit-site-form', 'add-category-modal',
                'add-category-form', 'edit-category-modal', 'edit-category-form', 'import-file-input',
                'size-slider-panel', 'size-slider', 'shape-select-btn', 'shape-select-menu',
                'increase-size-btn', 'decrease-size-btn',
                'confirm-modal', 'confirm-modal-title', 'confirm-modal-message', 'confirm-modal-btn',
                'user-actions-container', 'auth-modal', 'auth-title', 'auth-form', 'auth-email',
                'auth-password', 'auth-error', 'auth-submit-btn', 'auth-switch', 'auth-nickname',
                'forgot-password-link', 'forgot-password-modal', 'forgot-password-form',
                'search-results-container', 'search-stats', 'search-results-list',
                'custom-alert-modal', 'custom-alert-title', 'custom-alert-message',
                'search-clock', 'search-container', 'search-form', 'search-input',
                'search-suggestions-container', 'suggestion-tabs', 'suggestion-content', 'clear-history-btn',
                'ai-btn', 'ai-dropdown-menu', 'theme-btn', 'theme-dropdown-menu',
                'context-menu', 'main-context-menu',
                'wallpaper-container', 'wallpaper-controls', 'prev-wallpaper-btn',
                'play-pause-wallpaper-btn', 'next-wallpaper-btn', 'play-icon', 'pause-icon',
                'download-wallpaper-btn', 'wallpaper-info', 'toggle-watermark-btn',
                'wallpaper-gallery-trigger', 'wallpaper-gallery-panel', 'wallpaper-gallery-grid', 'wallpaper-gallery-categories-container',
                'gallery-loader',
                'manage-scopes-modal', 'manage-scopes-form', 'scope-list', 'scope-form-title',
                'scope-edit-id', 'scope-name', 'scope-sites', 'scope-filetype', 'scope-form-cancel',
                'scope-intitle', 'scope-intext', 'scope-exact-phrase', 'scope-exclude-words',
                'scope-time-range', 'scope-custom-date-range', 'scope-start-date', 'scope-end-date',
                'start-date-container', 'end-date-container',
                'search-scope-btn', 'search-scope-menu', 'active-scope-tag',
                'engine-btn', 'search-engine-menu', 'manage-engines-modal', 'engine-list', 
                'manage-engines-form-container', 'engine-form-title', 'manage-engines-form',
                'engine-edit-id', 'engine-name', 'engine-url', 'engine-icon-url', 'engine-form-cancel'
            ];

            // =================================================================
            // 本地存储模块
            // =================================================================
            const storage = {
                get: async function() {
                    const localData = localStorage.getItem(STATIC_CONFIG.CONSTANTS.STORAGE_KEY);
                    if (!localData) {
                        return null;
                    }
                    try {
                        return JSON.parse(localData);
                    } catch (e) {
                        console.error("解析本地存储数据失败:", e);
                        return null;
                    }
                },
                set: async function(data) {
                    try {
                        localStorage.setItem(STATIC_CONFIG.CONSTANTS.STORAGE_KEY, JSON.stringify(data));
                    } catch (e) {
                        console.error("写入本地存储失败:", e);
                    }
                }
            };

            // =================================================================
            // 核心功能模块
            // =================================================================
            const core = {
                loadUserData: async () => {
                    try {
                        let dataToLoad = null;
                        if (state.isLoggedIn && state.currentUser) {
                            console.log("从 Supabase 加载用户数据...");
                            try {
                                const { data, error } = await supabase
                                    .from('user_configs')
                                    .select('data')
                                    .eq('user_id', state.currentUser.id)
                                    .single();

                                if (error && error.code !== 'PGRST116') {
                                    throw error;
                                }
                                if (data) {
                                    dataToLoad = data.data;
                                    console.log("成功从 Supabase 加载数据。");
                                    await storage.set(dataToLoad);
                                } else {
                                    console.log("Supabase 中无用户数据，使用默认数据初始化。");
                                    dataToLoad = JSON.parse(JSON.stringify(STATIC_CONFIG.DEFAULT_USER_DATA));
                                    await core.saveUserData(dataToLoad);
                                }
                            } catch (error) {
                                console.error("从 Supabase 加载数据失败，将使用本地数据:", error);
                                dataToLoad = await storage.get();
                            }
                        } else {
                            console.log("从本地存储加载数据...");
                            dataToLoad = await storage.get();
                        }

                        const defaultData = JSON.parse(JSON.stringify(STATIC_CONFIG.DEFAULT_USER_DATA));

                        if (!dataToLoad || typeof dataToLoad !== 'object') {
                            state.userData = defaultData;
                        } else {
                            // [REVISED] Start with a deep copy of default data to ensure all keys exist
                            const mergedData = JSON.parse(JSON.stringify(defaultData));
                            
                            // Overwrite with user's top-level, non-array settings
                            for (const key in dataToLoad) {
                                if (Object.prototype.hasOwnProperty.call(dataToLoad, key) && !Array.isArray(dataToLoad[key])) {
                                    mergedData[key] = dataToLoad[key];
                                }
                            }

                            // Safely merge arrays
                            if (Array.isArray(dataToLoad.navItems)) {
                                mergedData.navItems = dataToLoad.navItems.filter(item => item && item.url && item.name).map(item => ({
                                    ...defaultData.navItems[0], // provides a default structure
                                    ...item
                                }));
                            }

                            if (Array.isArray(dataToLoad.searchEngines)) {
                                const userEngines = dataToLoad.searchEngines.filter(e => e && e.id && e.url);
                                const finalEngines = [...userEngines];
                                defaultData.searchEngines.forEach(defaultEngine => {
                                    if (!userEngines.some(userEngine => userEngine.id === defaultEngine.id)) {
                                        finalEngines.push(defaultEngine);
                                    }
                                });
                                mergedData.searchEngines = finalEngines;
                            }
                            
                            mergedData.navCategories = Array.isArray(dataToLoad.navCategories) ? dataToLoad.navCategories : defaultData.navCategories;
                            mergedData.searchHistory = Array.isArray(dataToLoad.searchHistory) ? dataToLoad.searchHistory : defaultData.searchHistory;
                            mergedData.searchScopes = Array.isArray(dataToLoad.searchScopes) ? dataToLoad.searchScopes : defaultData.searchScopes;

                            // Final check on active engine
                            if (!mergedData.searchEngines.find(e => e.id === mergedData.activeSearchEngineId)) {
                                mergedData.activeSearchEngineId = mergedData.searchEngines[0]?.id || defaultData.activeSearchEngineId;
                            }

                            state.userData = mergedData;
                        }
                        
                        if (!dataToLoad && !state.isLoggedIn) {
                            await core.saveUserData();
                        }

                        core.applyAllSettings();
                    } catch (e) {
                        console.error("加载用户数据时发生严重错误。重置为默认设置。", e);
                        state.userData = JSON.parse(JSON.stringify(STATIC_CONFIG.DEFAULT_USER_DATA));
                        core.applyAllSettings();
                        utils.showAlert("加载您的个人设置时遇到问题，已为您加载默认设置。", "加载错误");
                    }
                },

                saveUserData: async (dataToSave = state.userData) => {
                    if (state.isLoggedIn && state.currentUser) {
                        console.log("保存数据到 Supabase...");
                        const { error } = await supabase
                            .from('user_configs')
                            .upsert({ user_id: state.currentUser.id, data: dataToSave });

                        if (error) {
                            console.error("保存数据到 Supabase 失败:", error);
                        }
                    }
                    console.log("保存数据到本地存储。");
                    await storage.set(dataToSave);
                },

                applyAllSettings: () => {
                    render.dockControls();
                    const activeCategory = document.querySelector('#dock-category-list .active')?.dataset.category;
                    render.navItems(activeCategory);
                    core.applyShape(state.userData.navShape);
                    core.setNavItemSize(state.userData.navSize);
                    core.applyTheme(state.userData.theme);
                    core.applyDockPin(state.userData.isDockPinned);
                    render.searchScopeSelector();
                    render.activeScopeTag();
                    render.searchEngineSwitcher();
                    render.watermark();
                },

                register: async (email, password) => {
                    const nickname = dom.authNickname.value.trim();
                    if (!nickname) {
                        utils.showAlert('昵称不能为空！', '注册错误');
                        dom.authSubmitBtn.disabled = false;
                        dom.authSubmitBtn.textContent = '创建账户';
                        return;
                    }

                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                nickname: nickname
                            }
                        }
                    });

                    dom.authSubmitBtn.disabled = false;
                    dom.authSubmitBtn.textContent = '创建账户';

                    if (error) {
                        utils.showAlert(utils.translateSupabaseError(error), '注册失败');
                        return;
                    }
                    
                    if (data.user && data.user.identities && data.user.identities.length === 0) {
                        utils.showAlert('注册请求已发送，请检查您的邮箱以完成验证。', '验证邮件已发送');
                        dom.authModal.classList.remove('visible');
                    } else {
                        utils.showAlert(`注册成功！欢迎 ${nickname}，已为您自动登录。`, '欢迎');
                        dom.authModal.classList.remove('visible');
                    }
                },

                login: async (email, password) => {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    
                    dom.authSubmitBtn.disabled = false;
                    render.authModal();

                    if (error) {
                        utils.showAlert(utils.translateSupabaseError(error), '登录失败');
                    } else {
                         dom.authModal.classList.remove('visible');
                    }
                },

                logout: async () => {
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error("退出登录失败:", error);
                        utils.showAlert("退出登录时发生错误。");
                    } else {
                        utils.showAlert("您已退出登录。");
                    }
                },

                handlePasswordReset: async (email) => {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.href,
                    });

                    if (error) {
                        utils.showAlert(`操作失败: ${utils.translateSupabaseError(error)}`, '操作失败');
                    } else {
                        utils.showAlert("如果该邮箱已注册，一封重设密码的邮件将会发送到您的收件箱，请注意查收。");
                        dom.forgotPasswordModal.classList.remove('visible');
                    }
                },

                performSearch: (query) => {
                    if (!query) return;

                    state.userData.searchHistory = state.userData.searchHistory.filter(item => item !== query);
                    state.userData.searchHistory.unshift(query);
                    if (state.userData.searchHistory.length > 10) {
                        state.userData.searchHistory.pop();
                    }
                    core.saveUserData();

                    let finalQuery = query;
                    
                    if (state.activeSearchScopeId !== STATIC_CONFIG.CONSTANTS.DEFAULT_SCOPE_ID) {
                        const scope = state.userData.searchScopes.find(s => s.id === state.activeSearchScopeId);
                        if (scope) {
                            if (scope.intitle) finalQuery += ` intitle:${scope.intitle}`;
                            if (scope.intext) finalQuery += ` intext:${scope.intext}`;
                            if (scope.exactPhrase) finalQuery += ` "${scope.exactPhrase}"`;
                            if (scope.excludeWords) {
                                finalQuery += ` ${scope.excludeWords.trim().split(/\s+/).map(w => `-${w}`).join(' ')}`;
                            }
                            if (scope.sites && scope.sites.length > 0) {
                                finalQuery += ` ${scope.sites.map(s => `site:${s}`).join(' OR ')}`;
                            }
                            if (scope.filetype) finalQuery += ` filetype:${scope.filetype}`;
                            
                            const { startDate, endDate } = utils.getDateRange(scope.timeRange, scope.startDate, scope.endDate);
                            if (startDate) finalQuery += ` after:${startDate}`;
                            if (endDate) finalQuery += ` before:${endDate}`;
                        }
                    }

                    const engine = state.userData.searchEngines.find(e => e.id === state.userData.activeSearchEngineId);
                    if (!engine) {
                        utils.showAlert('未找到有效的搜索引擎配置。');
                        return;
                    }

                    const encodedQuery = encodeURIComponent(finalQuery.trim());
                    window.open(engine.url.replace(/\{query\}/gi, encodedQuery), '_blank');
                },


                updateClock: () => {
                    if (!dom.searchClock) return;
                    const now = new Date();
                    const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    const day = now.toLocaleDateString('zh-CN', { weekday: 'long' });
                    dom.searchClock.innerHTML = `${time}<div class="day">${day}</div>`;
                },

                startThemeRotation: () => {
                    if (state.themeInterval) clearInterval(state.themeInterval);
                    const rotate = () => {
                        state.currentThemeIndex = (state.currentThemeIndex + 1) % STATIC_CONFIG.THEMES.length;
                        dom.body.dataset.theme = STATIC_CONFIG.THEMES[state.currentThemeIndex];
                    };
                    rotate();
                    state.themeInterval = setInterval(rotate, 10000);
                },

                applyTheme: (theme) => {
                    if (state.themeInterval) {
                        clearInterval(state.themeInterval);
                        state.themeInterval = null;
                    }
                    if (theme === 'auto') {
                        core.startThemeRotation();
                    } else {
                        dom.body.dataset.theme = theme;
                    }
                },

                applyShape: (shape) => {
                    dom.body.classList.remove('shape-square', 'shape-h-capsule', 'shape-circle');
                    dom.body.classList.add(`shape-${shape}`);
                    state.userData.navShape = shape;
                },

                setNavItemSize: (size) => {
                    document.documentElement.style.setProperty('--nav-item-size', `${size}px`);
                    dom.sizeSlider.value = size;
                    state.userData.navSize = size;
                },
                
                applyDockPin: (isPinned) => {
                    const pinBtn = document.getElementById('pin-btn');
                    dom.dockContainer.classList.toggle('pinned', isPinned);
                    if (pinBtn) pinBtn.classList.toggle('pinned', isPinned);
                    state.userData.isDockPinned = isPinned;
                },

                exportData: () => {
                    const dataStr = JSON.stringify(state.userData, null, 2);
                    const blob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `灵动窗数据-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                importData: () => {
                    dom.importFileInput.click();
                },
                
                fetchAndSetWallpaper: async (index) => {
                    if (state.isWallpaperLoading) return;
                    state.isWallpaperLoading = true;

                    try {
                        const imageData = await core.getWallpaperData(index);
                        if (!imageData) throw new Error("无法获取壁纸数据");

                        state.nextWallpaper.src = imageData.url;
                        
                        return new Promise((resolve) => {
                            state.nextWallpaper.onload = () => {
                                render.updateWallpaperDOM(imageData);
                                state.isWallpaperLoading = false;
                                setTimeout(() => core.preloadNextWallpaper(index), 500);
                                resolve();
                            };
                            state.nextWallpaper.onerror = () => {
                                utils.showAlert('壁纸加载失败。');
                                state.isWallpaperLoading = false;
                                resolve();
                            };
                        });
                    } catch (error) {
                        console.error('获取壁纸失败:', error);
                        utils.showAlert('获取壁纸失败，请检查网络连接。');
                        state.isWallpaperLoading = false;
                        return Promise.resolve();
                    }
                },

                preloadNextWallpaper: async (currentIndex) => {
                    const nextIndex = core.getNextWallpaperIndex(currentIndex);
                    try {
                        const nextImageData = await core.getWallpaperData(nextIndex);
                        if (nextImageData) {
                            const preloader = new Image();
                            preloader.src = nextImageData.url;
                        }
                    } catch (error) {
                        console.error("Preloading failed:", error);
                    }
                },
                
                getWallpaperData: async (index, categoryOverride) => {
                    const category = categoryOverride || state.currentWallpaperCategory;
                    const source = STATIC_CONFIG.WALLPAPER_SOURCES[category];
                    if (!source) return null;
                    const cacheKey = `${category}-${index}`;

                    try {
                        if (source.type === 'bing_api') {
                            if (state.wallpaperCache[cacheKey]) return state.wallpaperCache[cacheKey];
                            const url = `https://www.bing.com/HPImageArchive.aspx?format=js&idx=${index}&n=1&mkt=zh-CN`;
                            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                            if (!response.ok) throw new Error(`Bing API fetch failed: ${response.status}`);
                            const text = await response.text();
                            if (!text) return null;
                            const bingData = JSON.parse(text);
                            const imageUrl = `https://www.bing.com${bingData.images[0].url}`;
                            const imageData = { url: imageUrl, info: bingData.images[0].copyright, category: category, index: index };
                            state.wallpaperCache[cacheKey] = imageData;
                            return imageData;
                        } else if (source.type === 'unsplash') {
                            const imageUrl = `${source.url}&random=${Date.now() + index}`;
                            return { url: imageUrl, info: source.name, category: category, index: index };
                        } else if (source.type === 'btstu') {
                            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(source.url)}`);
                            if (!response.ok) throw new Error(`btstu API fetch failed: ${response.status}`);
                            const text = await response.text();
                            if (!text) return null;
                            const data = JSON.parse(text);
                            if (data.code === "200" && data.imgurl) {
                                return { url: data.imgurl.replace(/\\/g, ''), info: source.name, category: category, index: index };
                            }
                            throw new Error('btstu API returned invalid data');
                        }
                    } catch (error) {
                        console.error(`Failed to get wallpaper for category "${category}":`, error);
                        return null;
                    }
                    return null;
                },

                getNextWallpaperIndex: (currentIndex) => {
                    const source = STATIC_CONFIG.WALLPAPER_SOURCES[state.currentWallpaperCategory];
                    if (source.type === 'bing_api') {
                        return (currentIndex - 1 + 8) % 8;
                    } else {
                        return Date.now();
                    }
                },

                enterTheaterMode: async () => {
                    if (state.isTheaterMode) return;
                    
                    try {
                        await core.fetchAndSetWallpaper(state.currentWallpaperIndex);
                        dom.body.classList.add('theater-mode-active');
                        dom.wallpaperContainer.classList.add('visible');
                        state.isTheaterMode = true;
                    } catch (error) {
                        // Error is handled in fetchAndSetWallpaper
                    }
                },

                exitTheaterMode: () => {
                    if (!state.isTheaterMode) return;
                    
                    core.stopSlideshow();
                    dom.body.classList.remove('theater-mode-active');
                    dom.wallpaperContainer.classList.remove('visible');
                    dom.wallpaperGalleryPanel.classList.remove('visible');
                    
                    setTimeout(() => {
                        state.isTheaterMode = false;
                    }, 2500); 
                },
                
                handleNextWallpaper: () => {
                    state.currentWallpaperIndex = core.getNextWallpaperIndex(state.currentWallpaperIndex);
                    core.fetchAndSetWallpaper(state.currentWallpaperIndex);
                },

                handlePrevWallpaper: () => {
                    const source = STATIC_CONFIG.WALLPAPER_SOURCES[state.currentWallpaperCategory];
                    if (source.type === 'bing_api') {
                        state.currentWallpaperIndex = (state.currentWallpaperIndex + 1) % 8;
                    } else {
                        state.currentWallpaperIndex = Date.now();
                    }
                    core.fetchAndSetWallpaper(state.currentWallpaperIndex);
                },
                
                toggleSlideshow: () => {
                    if (state.isSlideshowPlaying) {
                        core.stopSlideshow();
                    } else {
                        core.startSlideshow();
                    }
                },

                startSlideshow: () => {
                    if (state.isSlideshowPlaying) return;
                    state.isSlideshowPlaying = true;
                    dom.playIcon.classList.add('hidden');
                    dom.pauseIcon.classList.remove('hidden');
                    core.handleNextWallpaper(); 
                    state.slideshowInterval = setInterval(core.handleNextWallpaper, 10000);
                },

                stopSlideshow: () => {
                    if (!state.isSlideshowPlaying) return;
                    clearInterval(state.slideshowInterval);
                    state.isSlideshowPlaying = false;
                    dom.playIcon.classList.remove('hidden');
                    dom.pauseIcon.classList.add('hidden');
                },
                
                handleDownloadWallpaper: async () => {
                    const currentBg = dom.wallpaperContainer.style.backgroundImage;
                    if (!currentBg || currentBg === 'none') {
                         utils.showAlert('无法获取当前壁纸信息。');
                         return;
                    }
                    const currentUrl = currentBg.slice(5, -2);

                    try {
                        const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(currentUrl)}`);
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `wallpaper-${Date.now()}.jpg`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    } catch (error) {
                        console.error('下载失败:', error);
                        utils.showAlert('下载失败。由于浏览器安全限制，请尝试右键点击背景并选择“图片另存为”。');
                    }
                },


                toggleWallpaperGallery: () => {
                    const panel = dom.wallpaperGalleryPanel;
                    if (panel.classList.contains('visible')) {
                        panel.classList.remove('visible');
                    } else {
                        state.currentWallpaperPage = 1;
                        state.isLoadingMoreWallpapers = false;
                        panel.classList.add('visible');
                        render.wallpaperGallery(true);
                    }
                },

                setWallpaperFromGallery: (category, index, url) => {
                    state.currentWallpaperCategory = category;
                    state.currentWallpaperIndex = index;
                    core.stopSlideshow();
                    
                    const source = STATIC_CONFIG.WALLPAPER_SOURCES[category];
                    const imageData = { url: url, info: source.name };
                    
                    const img = new Image();
                    img.src = imageData.url;
                    img.onload = () => {
                        render.updateWallpaperDOM(imageData);
                    };
                    
                    core.toggleWallpaperGallery();
                },
            };

            // =================================================================
            // 渲染模块 (更新UI)
            // =================================================================
            const render = {
                updateWallpaperDOM: (imageData) => {
                    const container = dom.wallpaperContainer;
                    
                    const currentBg = window.getComputedStyle(container).backgroundImage;
                    container.style.setProperty('--wallpaper-url-old', currentBg);
                    container.classList.add('is-loading');
                    container.style.backgroundImage = `url(${imageData.url})`;
                    
                    setTimeout(() => {
                        container.classList.remove('is-loading');
                        render.watermark(imageData.info);
                    }, 50);
                },
                
                watermark: (infoText = '') => {
                    const infoEl = dom.wallpaperInfo;
                    const toggleBtn = dom.toggleWatermarkBtn;

                    infoEl.textContent = infoText;
                    infoEl.classList.toggle('visible', state.userData.showWatermark && !!infoText);
                    toggleBtn.classList.toggle('active', state.userData.showWatermark);
                },

                navigationView: () => {
                    dom.navGrid.classList.remove('hidden');
                    dom.searchResultsContainer.classList.add('hidden');
                    dom.bottomDockWrapper.classList.remove('hidden');
                },
                dockControls: () => {
                    const fragment = document.createDocumentFragment();
                    
                    const addBtnContainer = document.createElement('div');
                    addBtnContainer.className = 'add-btn-container';
                    addBtnContainer.style.position = 'relative';
                    addBtnContainer.innerHTML = `
                        <button id="add-btn" class="add-btn dock-action-btn" aria-haspopup="true" aria-expanded="false">+</button>
                        <div id="add-menu" class="dropdown-menu" role="menu"></div>`;

                    const categoryList = document.createElement('div');
                    categoryList.id = 'dock-category-list';

                    const pinBtn = document.createElement('button');
                    pinBtn.id = 'pin-btn';
                    pinBtn.className = 'dock-action-btn';
                    pinBtn.title = '钉选任务栏';
                    pinBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/></svg>`;

                    fragment.appendChild(pinBtn);
                    fragment.appendChild(addBtnContainer);
                    fragment.appendChild(categoryList);

                    dom.dockControls.innerHTML = '';
                    dom.dockControls.appendChild(fragment);
                    
                    render.dockCategories();
                    render.addMenu(); 
                },
                dockCategories: () => {
                    const listEl = document.getElementById('dock-category-list');
                    if (!listEl) return;

                    const currentActiveCategory = document.querySelector('#dock-category-list .active')?.dataset.category || STATIC_CONFIG.CONSTANTS.ALL_CATEGORIES;
                    const fragment = document.createDocumentFragment();

                    const createButton = (category) => {
                        const btn = document.createElement('button');
                        btn.className = 'dock-category-btn';
                        btn.dataset.category = category;
                        btn.textContent = category;
                        if (category === currentActiveCategory) btn.classList.add('active');
                        return btn;
                    };

                    fragment.appendChild(createButton(STATIC_CONFIG.CONSTANTS.ALL_CATEGORIES));
                    state.userData.navCategories.forEach(category => {
                        fragment.appendChild(createButton(category));
                    });

                    listEl.innerHTML = '';
                    listEl.appendChild(fragment);
                },
                
                addMenu: () => {
                    const addMenuEl = document.getElementById('add-menu');
                    if (!addMenuEl) return;
                    const menuItems = [
                        { action: 'import-data', text: '导入数据' },
                        { action: 'export-data', text: '导出数据' },
                    ];
                    const fragment = document.createDocumentFragment();
                    menuItems.forEach(menuItem => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'dropdown-item';
                        item.dataset.action = menuItem.action;
                        item.textContent = menuItem.text;
                        fragment.appendChild(item);
                    });
                    addMenuEl.innerHTML = '';
                    addMenuEl.appendChild(fragment);
                },

                aiTools: () => {
                    const fragment = document.createDocumentFragment();
                    for (const [key, config] of Object.entries(STATIC_CONFIG.AI_TOOLS)) {
                        const item = document.createElement('a');
                        item.href = config.homeUrl;
                        item.target = '_blank';
                        item.rel = 'noopener noreferrer';
                        item.className = 'dropdown-item ai-link';
                        item.dataset.tool = key;
                        item.innerHTML = `
                            <img src="${config.icon}" class="dropdown-item-favicon" alt="${config.name}" onerror="this.src='https://placehold.co/16x16/e8eaed/e8eaed?text=${config.name.charAt(0)}'">
                            <span>${config.name}</span>`;
                        fragment.appendChild(item);
                    }
                    const aiDropdownMenu = document.getElementById('ai-dropdown-menu');
                    if(aiDropdownMenu) {
                       aiDropdownMenu.innerHTML = '';
                       aiDropdownMenu.appendChild(fragment);
                    }
                },

                themes: () => {
                    const fragment = document.createDocumentFragment();
                    const themeNames = { aurora: '极光', sunset: '日落', ocean: '海洋', neon: '霓虹', forest: '森林', cosmic: '宇宙' };
                    ['auto', ...STATIC_CONFIG.THEMES].forEach(theme => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'dropdown-item theme-choice';
                        item.dataset.theme = theme;
                        item.textContent = theme === 'auto' ? '自动' : themeNames[theme];
                        fragment.appendChild(item);
                    });
                    const themeDropdownMenu = document.getElementById('theme-dropdown-menu');
                    if (themeDropdownMenu) {
                        themeDropdownMenu.innerHTML = '';
                        themeDropdownMenu.appendChild(fragment);
                    }
                },
                
                shapeMenu: () => {
                    const shapes = [
                        { shape: 'square', text: '方形', icon: '<path d="M3 3v18h18V3H3zm16 16H5V5h14v14z"></path>' },
                        { shape: 'circle', text: '圆形', icon: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path>'},
                        { shape: 'h-capsule', text: '横向胶囊', icon: '<path d="M21 11H3c-1.1 0-2 .9-2 2v0c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2v0c0-1.1-.9-2-2-2z"></path>' }
                    ];
                    const fragment = document.createDocumentFragment();
                    shapes.forEach(s => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'dropdown-item shape-choice';
                        item.dataset.shape = s.shape;
                        item.innerHTML = `<svg class="header-btn-icon" viewBox="0 0 24 24">${s.icon}</svg><span>${s.text}</span>`;
                        fragment.appendChild(item);
                    });
                    dom.shapeSelectMenu.innerHTML = '';
                    dom.shapeSelectMenu.appendChild(fragment);
                },
                
                wallpaperGalleryCategories: () => {
                    const container = dom.wallpaperGalleryCategoriesContainer;
                    if (!container) return;
                    const fragment = document.createDocumentFragment();
                    
                    const categories = { 
                        'all': '全部', 
                        ...Object.fromEntries(Object.entries(STATIC_CONFIG.WALLPAPER_SOURCES).map(([key, value]) => [key, value.name])) 
                    };

                    for (const [key, name] of Object.entries(categories)) {
                        const btn = document.createElement('button');
                        btn.className = 'wallpaper-gallery-category-btn';
                        btn.dataset.category = key;
                        btn.textContent = name;
                        if (key === state.activeWallpaperGalleryCategory) {
                            btn.classList.add('active');
                        }
                        fragment.appendChild(btn);
                    }
                    
                    container.innerHTML = '';
                    container.appendChild(fragment);
                },

                wallpaperInfo: (info) => {
                    dom.wallpaperInfo.textContent = info || '';
                    render.watermark(info);
                },

                wallpaperGallery: async (clearExisting = false) => {
                    if (clearExisting) {
                        dom.wallpaperGalleryGrid.innerHTML = '';
                        state.galleryUrlCache.clear();
                        dom.wallpaperGalleryPanel.scrollTop = 0;
                    }

                    dom.galleryLoader.classList.remove('hidden');
                    state.isLoadingMoreWallpapers = true;

                    const activeCategory = state.activeWallpaperGalleryCategory;
                    const fragment = document.createDocumentFragment();
                    
                    let sourcesToFetch = [];
                    if (activeCategory === 'all') {
                        for (let i = 0; i < 4; i++) { sourcesToFetch.push({ type: 'bing_api', index: i }); }
                        Object.entries(STATIC_CONFIG.WALLPAPER_SOURCES).forEach(([key, source]) => {
                            if (source.type !== 'bing_api') {
                                for (let i = 0; i < 4; i++) {
                                    sourcesToFetch.push({ type: source.type, category: key, index: Math.random(), url: source.url, info: source.name });
                                }
                            }
                        });
                    } else {
                        const source = STATIC_CONFIG.WALLPAPER_SOURCES[activeCategory];
                        const perPage = source.type === 'bing_api' ? 8 : STATIC_CONFIG.CONSTANTS.WALLPAPERS_PER_PAGE;
                        for (let i = 0; i < perPage; i++) {
                             const uniqueIndex = (state.currentWallpaperPage - 1) * perPage + i;
                             sourcesToFetch.push({ type: source.type, category: activeCategory, index: uniqueIndex, url: source.url, info: source.name });
                        }
                    }

                    const promises = sourcesToFetch.map(source => core.getWallpaperData(source.index, source.category || activeCategory));
                    const imagesToRender = (await Promise.all(promises)).filter(Boolean);
                    
                    if (imagesToRender.length === 0 && state.currentWallpaperPage > 1) {
                        dom.galleryLoader.textContent = '没有更多壁纸了';
                        state.isLoadingMoreWallpapers = true;
                        return;
                    }

                    imagesToRender.forEach(({ url, info, category, index }) => {
                        if (state.galleryUrlCache.has(url)) return;
                        state.galleryUrlCache.add(url);

                        const item = document.createElement('div');
                        item.className = 'wallpaper-gallery-item';
                        item.dataset.category = category;
                        item.dataset.index = index;
                        item.dataset.url = url;
                        item.innerHTML = `<img src="${url}" alt="${info || 'Wallpaper'}" loading="lazy" onerror="this.parentElement.style.display='none'">`;
                        fragment.appendChild(item);
                    });

                    dom.wallpaperGalleryGrid.appendChild(fragment);
                    dom.galleryLoader.classList.add('hidden');
                    state.isLoadingMoreWallpapers = false;
                },


                createNavItemElement: (item, index, origin) => {
                    const navItem = document.createElement('a');
                    navItem.href = item.url;
                    navItem.target = '_blank';
                    navItem.className = 'nav-item';
                    navItem.draggable = true;
                    navItem.dataset.index = index;
                    navItem.dataset.url = item.url;
                    navItem.dataset.origin = origin;
                    navItem.innerHTML = `
                        <div class="nav-icon-wrapper">
                            <img src="${item.icon}" alt="${item.name}" onerror="this.onerror=null; this.src='https://placehold.co/32x32/f0f0f0/000000?text=${item.name.charAt(0)}'">
                        </div>
                        <span class="nav-label">${item.name}</span>`;
                    return navItem;
                },

                navItems: (category = STATIC_CONFIG.CONSTANTS.ALL_CATEGORIES) => {
                    const itemsToRender = category === STATIC_CONFIG.CONSTANTS.ALL_CATEGORIES
                        ? state.userData.navItems
                        : state.userData.navItems.filter(item => item.category === category);

                    const currentItems = dom.navGrid.querySelectorAll('.nav-item');
                    currentItems.forEach(item => item.classList.add('slide-out'));

                    setTimeout(() => {
                        dom.navGrid.innerHTML = '';
                        const fragment = document.createDocumentFragment();
                        itemsToRender.forEach((item) => {
                            const originalIndex = state.userData.navItems.findIndex(originalItem => originalItem.url === item.url);
                            const navItemEl = render.createNavItemElement(item, originalIndex, 'main');
                            navItemEl.classList.add('slide-in');
                            fragment.appendChild(navItemEl);
                        });
                        dom.navGrid.appendChild(fragment);
                    }, 250);
                },

                userActions: () => {
                    dom.userActionsContainer.innerHTML = '';
                    if (state.isLoggedIn && state.currentUser) {
                        const userBtn = document.createElement('button');
                        userBtn.id = 'user-btn';
                        userBtn.className = 'header-btn';
                        userBtn.setAttribute('aria-haspopup', 'true');
                        userBtn.setAttribute('aria-expanded', 'false');

                        // --- [FIX START] 增加渲染的防御性 ---
                        const nickname = state.currentUser?.user_metadata?.nickname || state.currentUser?.email?.split('@')[0] || '用户';
                        const email = state.currentUser?.email || '';
                        // --- [FIX END] ---

                        userBtn.innerHTML = `
                            <div class="user-avatar">
                                ${nickname.charAt(0).toUpperCase()}
                            </div>
                        `;

                        const userMenu = document.createElement('div');
                        userMenu.id = 'user-menu';
                        userMenu.className = 'dropdown-menu';
                        userMenu.role = 'menu';
                        userMenu.innerHTML = `
                            <div class="user-info">
                                <strong class="user-info-name">${nickname}</strong>
                                <small class="user-info-email">${email}</small>
                            </div>
                            <div class="context-menu-divider"></div>
                            <a href="#" class="dropdown-item" data-action="logout">退出登录</a>
                        `;

                        dom.userActionsContainer.appendChild(userBtn);
                        dom.userActionsContainer.appendChild(userMenu);
                    } else {
                        const loginBtn = document.createElement('button');
                        loginBtn.id = 'login-btn';
                        loginBtn.className = 'header-btn';
                        loginBtn.dataset.action = 'show-auth';
                        loginBtn.innerHTML = `
                            <div class="login-indicator">
                                <svg viewBox="0 0 24 24"><path d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"></path></svg>
                            </div>`;
                        dom.userActionsContainer.appendChild(loginBtn);
                    }
                },

                authModal: () => {
                    const nicknameGroup = document.getElementById('nickname-group');
                    const forgotPasswordLink = document.getElementById('forgot-password-link');

                    if (state.isRegisterMode) {
                        dom.authTitle.textContent = '注册';
                        dom.authSubmitBtn.textContent = '创建账户';
                        dom.authSwitch.innerHTML = '已有账户？<a>立即登录</a>';
                        if (nicknameGroup) nicknameGroup.style.display = 'block';
                        if (forgotPasswordLink) forgotPasswordLink.style.display = 'none';
                    } else {
                        dom.authTitle.textContent = '登录';
                        dom.authSubmitBtn.textContent = '登录';
                        dom.authSwitch.innerHTML = '还没有账户？<a>立即注册</a>';
                        if (nicknameGroup) nicknameGroup.style.display = 'none';
                        if (forgotPasswordLink) forgotPasswordLink.style.display = 'block';
                    }
                    dom.authError.textContent = '';
                    dom.authForm.reset();
                },

                suggestions: (items, type) => {
                    if (!dom.suggestionContent) return;

                    if (!items || items.length === 0) {
                        const message = type === 'history' ? '无历史记录' : '无相关建议';
                        dom.suggestionContent.innerHTML = `<div class="dropdown-item" style="justify-content: center; color: var(--text-secondary);">${message}</div>`;
                        dom.searchSuggestionsContainer.classList.add('visible');
                        return;
                    }

                    const fragment = document.createDocumentFragment();
                    items.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item suggestion-item';
                        div.dataset.value = item;
                        if (index === state.activeSuggestionIndex) {
                            div.classList.add('active');
                        }

                        const textSpan = document.createElement('span');
                        textSpan.textContent = item;
                        div.appendChild(textSpan);

                        if (type === 'history') {
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-history-btn';
                            removeBtn.innerHTML = '&times;';
                            removeBtn.title = '删除此条记录';
                            removeBtn.dataset.index = index;
                            div.appendChild(removeBtn);
                        }
                        fragment.appendChild(div);
                    });
                    
                    dom.suggestionContent.innerHTML = '';
                    dom.suggestionContent.appendChild(fragment);
                    dom.searchSuggestionsContainer.classList.add('visible');
                },

                searchScopeSelector: () => {
                    const menu = dom.searchScopeMenu;
                    menu.innerHTML = '';
                    const fragment = document.createDocumentFragment();

                    const defaultItem = document.createElement('a');
                    defaultItem.href = '#';
                    defaultItem.className = 'dropdown-item scope-menu-item';
                    defaultItem.dataset.scopeId = STATIC_CONFIG.CONSTANTS.DEFAULT_SCOPE_ID;
                    defaultItem.innerHTML = `<span class="icon">🌐</span><span>全网搜索</span>`;
                    if (state.activeSearchScopeId === STATIC_CONFIG.CONSTANTS.DEFAULT_SCOPE_ID) {
                        defaultItem.classList.add('active');
                    }
                    fragment.appendChild(defaultItem);

                    state.userData.searchScopes.forEach(scope => {
                        const scopeItem = document.createElement('a');
                        scopeItem.href = '#';
                        scopeItem.className = 'dropdown-item scope-menu-item';
                        scopeItem.dataset.scopeId = scope.id;
                        scopeItem.innerHTML = `<span class="icon">🎯</span><span>${scope.name}</span>`;
                        if (state.activeSearchScopeId === scope.id) {
                            scopeItem.classList.add('active');
                        }
                        fragment.appendChild(scopeItem);
                    });
                    
                    const divider = document.createElement('div');
                    divider.className = 'context-menu-divider';
                    fragment.appendChild(divider);

                    const manageItem = document.createElement('a');
                    manageItem.href = '#';
                    manageItem.className = 'dropdown-item';
                    manageItem.dataset.action = 'manage-scopes';
                    manageItem.innerHTML = '<span>+ 添加/管理范围...</span>';
                    fragment.appendChild(manageItem);

                    menu.appendChild(fragment);
                },
                
                activeScopeTag: () => {
                    const tag = dom.activeScopeTag;
                    const input = dom.searchInput;
                    if (state.activeSearchScopeId === STATIC_CONFIG.CONSTANTS.DEFAULT_SCOPE_ID) {
                        tag.classList.remove('visible');
                        input.classList.remove('has-scope');
                        input.style.paddingLeft = '';
                        tag.textContent = '';
                    } else {
                        const scope = state.userData.searchScopes.find(s => s.id === state.activeSearchScopeId);
                        if (scope) {
                            tag.textContent = scope.name;
                            tag.classList.add('visible');
                            input.classList.add('has-scope');
                            setTimeout(() => {
                                const tagWidth = tag.offsetWidth;
                                input.style.paddingLeft = `${tagWidth + 50}px`;
                            }, 0);
                        }
                    }
                },

                manageScopesModal: () => {
                    const list = dom.scopeList;
                    list.innerHTML = '';
                    if (state.userData.searchScopes.length === 0) {
                        list.innerHTML = '<li style="text-align: center; color: var(--text-secondary); font-size: 13px;">尚未创建任何搜索范围</li>';
                    } else {
                        const fragment = document.createDocumentFragment();
                        state.userData.searchScopes.forEach(scope => {
                            const li = document.createElement('li');
                            li.className = 'scope-list-item';
                            li.innerHTML = `
                                <span class="scope-list-item-name">${scope.name}</span>
                                <div class="scope-list-item-actions">
                                    <button type="button" data-action="edit-scope" data-scope-id="${scope.id}">编辑</button>
                                    <button type="button" data-action="delete-scope" data-scope-id="${scope.id}" class="delete">删除</button>
                                </div>
                            `;
                            fragment.appendChild(li);
                        });
                        list.appendChild(fragment);
                    }
                    dom.manageScopesForm.reset();
                    dom.scopeEditId.value = '';
                    dom.scopeFormTitle.textContent = '创建新范围';
                    dom.scopeFormCancel.classList.add('hidden');
                    dom.scopeCustomDateRange.classList.add('hidden');
                },
                
                searchEngineSwitcher: () => {
                    const engine = state.userData.searchEngines.find(e => e.id === state.userData.activeSearchEngineId) || state.userData.searchEngines[0];
                    if (engine) {
                        dom.engineBtn.querySelector('img').src = engine.icon;
                        dom.engineBtn.querySelector('img').alt = engine.name;
                    }
                    render.searchEngineMenu();
                },

                searchEngineMenu: () => {
                    const menu = dom.searchEngineMenu;
                    menu.innerHTML = '';
                    const fragment = document.createDocumentFragment();

                    state.userData.searchEngines.forEach(engine => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'dropdown-item';
                        item.dataset.action = 'switch-engine';
                        item.dataset.engineId = engine.id;
                        item.innerHTML = `
                            <img src="${engine.icon}" class="dropdown-item-favicon" alt="${engine.name}">
                            <span>${engine.name}</span>
                        `;
                        if (engine.id === state.userData.activeSearchEngineId) {
                            item.classList.add('active');
                        }
                        fragment.appendChild(item);
                    });

                    const divider = document.createElement('div');
                    divider.className = 'context-menu-divider';
                    fragment.appendChild(divider);

                    const manageItem = document.createElement('a');
                    manageItem.href = '#';
                    manageItem.className = 'dropdown-item';
                    manageItem.dataset.action = 'manage-engines';
                    manageItem.innerHTML = '<span>+ 添加/管理引擎...</span>';
                    fragment.appendChild(manageItem);

                    menu.appendChild(fragment);
                },

                manageEnginesModal: () => {
                    const list = dom.engineList;
                    list.innerHTML = '';
                    if (state.userData.searchEngines.length === 0) {
                        list.innerHTML = '<li style="text-align: center; color: var(--text-secondary); font-size: 13px;">尚未添加任何搜索引擎</li>';
                    } else {
                        const fragment = document.createDocumentFragment();
                        state.userData.searchEngines.forEach(engine => {
                            const li = document.createElement('li');
                            li.className = 'engine-list-item';
                            li.innerHTML = `
                                <span class="engine-list-item-name">
                                    <img src="${engine.icon}" alt="${engine.name}">
                                    ${engine.name}
                                </span>
                                <div class="engine-list-item-actions">
                                    <button type="button" data-action="edit-engine" data-engine-id="${engine.id}">编辑</button>
                                    <button type="button" data-action="delete-engine" data-engine-id="${engine.id}" class="delete">删除</button>
                                </div>
                            `;
                            fragment.appendChild(li);
                        });
                        list.appendChild(fragment);
                    }
                    dom.manageEnginesForm.reset();
                    dom.engineEditId.value = '';
                    dom.engineFormTitle.textContent = '添加新引擎';
                    dom.engineFormCancel.classList.add('hidden');
                }
            };

            // =================================================================
            // 工具函数模块
            // =================================================================
            const utils = {
                debounce: (func, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                },
                jsonp: (url, callbackParamName = 'callback') => {
                    return new Promise((resolve, reject) => {
                        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                        const script = document.createElement('script');
                        
                        window[callbackName] = (data) => {
                            delete window[callbackName];
                            document.head.removeChild(script);
                            resolve(data);
                        };

                        script.src = `${url}${url.includes('?') ? '&' : ''}${callbackParamName}=${callbackName}`;
                        script.onerror = (err) => {
                            delete window[callbackName];
                            document.head.removeChild(script);
                            reject(err);
                        };
                        
                        document.head.appendChild(script);
                    });
                },
                showConfirmModal: (message, onConfirm) => {
                    dom.confirmModalMessage.textContent = message;
                    dom.confirmModal.classList.add('visible');
                    state.confirmCallback = onConfirm;
                },
                showAlert: (message, title = '提示') => {
                    dom.customAlertTitle.textContent = title;
                    dom.customAlertMessage.textContent = message;
                    dom.customAlertModal.classList.add('visible');
                },
                translateSupabaseError: (error) => {
                    if (error.message.includes("User already registered")) return "该邮箱已被注册。";
                    if (error.message.includes("Invalid login credentials")) return "无效的登录凭据（邮箱或密码错误）。";
                    if (error.message.includes("Password should be at least 6 characters")) return "密码长度至少为6位。";
                    return error.message || '发生未知错误，请稍后再试。';
                },
                toggleDropdown: (button, menu) => {
                    if (menu.id === 'search-scope-menu') {
                        dom.searchSuggestionsContainer.classList.remove('visible');
                    }
                    const isExpanded = menu.classList.toggle('visible');
                    button.setAttribute('aria-expanded', isExpanded);

                    if (isExpanded && (menu.id === 'ai-dropdown-menu' || menu.id === 'theme-dropdown-menu' || menu.id === 'search-engine-menu')) {
                        setTimeout(() => {
                            const buttonWidth = button.offsetWidth;
                            const menuWidth = menu.offsetWidth;
                            menu.style.left = `${(buttonWidth - menuWidth) / 2}px`;
                        }, 0);
                    }
                },
                closeAllDropdowns: () => {
                    document.querySelectorAll('.dropdown-menu.visible').forEach(menu => {
                        if (menu.id !== 'search-suggestions-container') {
                           menu.classList.remove('visible');
                           const btn = menu.parentElement.querySelector('[aria-expanded="true"]');
                           if (btn) btn.setAttribute('aria-expanded', 'false');
                        }
                    });
                    dom.contextMenu.classList.remove('visible');
                    dom.mainContextMenu.classList.remove('visible');
                },
                populateCategoryDropdowns: (selectElement, selectedCategory = '') => {
                    selectElement.innerHTML = '';
                    state.userData.navCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        if (cat === selectedCategory) option.selected = true;
                        selectElement.appendChild(option);
                    });
                    const newOption = document.createElement('option');
                    newOption.value = STATIC_CONFIG.CONSTANTS.NEW_CATEGORY_VALUE;
                    newOption.textContent = '创建新分类...';
                    selectElement.appendChild(newOption);
                },
                processSiteForm: async (formId) => {
                    const isEdit = formId === 'edit-site-form';
                    const camelCaseFormId = formId.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    const formElement = dom[camelCaseFormId];

                    if (!formElement) return;

                    const name = formElement.querySelector(isEdit ? '#edit-site-name' : '#site-name').value.trim();
                    let url = formElement.querySelector(isEdit ? '#edit-site-url' : '#site-url').value.trim();
                    const iconHiddenInput = formElement.querySelector(isEdit ? '#edit-site-icon-hidden' : '#site-icon-hidden');
                    let iconUrl = iconHiddenInput.value.trim();
                    const categorySelect = formElement.querySelector(isEdit ? '#edit-site-category-select' : '#site-category-select');
                    const newCategoryInput = formElement.querySelector(isEdit ? '#edit-site-category-new' : '#site-category-new');

                    let category = categorySelect.value;
                    if (category === STATIC_CONFIG.CONSTANTS.NEW_CATEGORY_VALUE) {
                        category = newCategoryInput.value.trim();
                    }

                    if (!name || !url || !category) {
                        utils.showAlert('请填写所有字段！');
                        return;
                    }

                    if (!url.match(/^https?:\/\//)) {
                        url = 'https://' + url;
                    }

                    try {
                        if (!iconUrl) {
                            iconUrl = `https://icon.bqb.cool/?url=${new URL(url).hostname}`;
                        }
                        
                        const itemData = { name, url, icon: iconUrl, category };

                        if (isEdit) {
                            const index = formElement.querySelector('#edit-site-index').value;
                            state.userData.navItems[index] = itemData;
                        } else {
                            state.userData.navItems.push(itemData);
                        }

                        if (!state.userData.navCategories.includes(category)) {
                            state.userData.navCategories.push(category);
                        }

                        await core.saveUserData();
                        render.dockCategories();
                        const activeCategory = document.querySelector('#dock-category-list .active')?.dataset.category;
                        render.navItems(activeCategory);

                        formElement.reset();
                        dom[isEdit ? 'editSiteModal' : 'addSiteModal'].classList.remove('visible');
                    } catch (error) {
                        utils.showAlert("操作失败，请输入一个有效的网址或检查网络连接。", "错误");
                    }
                },
                purifyUrl: (url) => {
                    try {
                        let fullUrl = url.trim();
                        if (!fullUrl) return '';
                        if (!fullUrl.match(/^https?:\/\//)) {
                            fullUrl = 'https://' + fullUrl;
                        }
                        const urlObject = new URL(fullUrl);
                        return urlObject.hostname.replace(/^www\./, '');
                    } catch (e) {
                        return url.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0].trim();
                    }
                },
                formatSearchUrl: (pastedUrl) => {
                    try {
                        let decodedUrl = decodeURIComponent(pastedUrl);

                        if (/\{query\}/i.test(decodedUrl)) {
                            return decodedUrl.replace(/\{query\}/i, '{query}');
                        }

                        const url = new URL(decodedUrl);
                        const params = url.searchParams;
                        const commonKeys = ['q', 'query', 'wd', 'keyword', 'search', 'text', 's'];
                        
                        for (const key of commonKeys) {
                            if (params.has(key)) {
                                params.set(key, '{query}');
                                return `${url.origin}${url.pathname}?${params.toString()}`;
                            }
                        }
                        
                        return `${url.origin}${url.pathname}?q={query}`;
                    } catch (e) {
                        return pastedUrl;
                    }
                },
                getDateRange: (timeRangeType, customStart, customEnd) => {
                    const now = new Date();
                    let startDate = '';
                    let endDate = '';

                    const subtractDays = (date, days) => {
                        const newDate = new Date(date);
                        newDate.setDate(newDate.getDate() - days);
                        return newDate.toISOString().slice(0, 10);
                    };

                    switch (timeRangeType) {
                        case 'day':
                            startDate = subtractDays(now, 1);
                            endDate = now.toISOString().slice(0, 10);
                            break;
                        case 'week':
                            startDate = subtractDays(now, 7);
                            endDate = now.toISOString().slice(0, 10);
                            break;
                        case 'month':
                            const lastMonth = new Date(now);
                            lastMonth.setMonth(now.getMonth() - 1);
                            startDate = lastMonth.toISOString().slice(0, 10);
                            endDate = now.toISOString().slice(0, 10);
                            break;
                        case 'year':
                             const lastYear = new Date(now);
                            lastYear.setFullYear(now.getFullYear() - 1);
                            startDate = lastYear.toISOString().slice(0, 10);
                            endDate = now.toISOString().slice(0, 10);
                            break;
                        case 'after':
                            startDate = customStart || '';
                            break;
                        case 'before':
                            endDate = customEnd || '';
                            break;
                        case 'custom':
                            startDate = customStart || '';
                            endDate = customEnd || '';
                            break;
                        default:
                            return { startDate: '', endDate: '' };
                    }
                    return { startDate, endDate };
                }
            };
            
            // =================================================================
            // 拖放模块
            // =================================================================
            const dnd = {
                handleDragStart: (e) => {
                    const target = e.target.closest('.nav-item');
                    if (!target) {
                        e.preventDefault();
                        return;
                    }
                    state.draggedItem = {
                        url: target.dataset.url,
                        origin: target.dataset.origin,
                        element: target
                    };
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => target.style.opacity = '0.5', 0);
                },

                handleDragEnd: (e) => {
                    if (state.draggedItem && state.draggedItem.element) {
                        state.draggedItem.element.style.opacity = '1';
                    }
                    state.draggedItem = null;
                },

                handleDragOver: (e) => {
                    e.preventDefault();
                    if (!state.draggedItem) return;
                },

                handleDrop: (e) => {
                    e.preventDefault();
                    if (!state.draggedItem || state.draggedItem.origin !== 'main') return;

                    const dropZone = e.currentTarget.closest('#nav-grid');
                    if (!dropZone) return;

                    const itemIndex = state.userData.navItems.findIndex(i => i.url === state.draggedItem.url);
                    if (itemIndex === -1) return;
                    
                    const [itemData] = state.userData.navItems.splice(itemIndex, 1);

                    const afterElement = e.target.closest('.nav-item');
                    if (afterElement && afterElement.dataset.origin === 'main') {
                        const newIndex = state.userData.navItems.findIndex(i => i.url === afterElement.dataset.url);
                        state.userData.navItems.splice(newIndex, 0, itemData);
                    } else {
                        state.userData.navItems.push(itemData);
                    }
                    
                    core.saveUserData();
                    core.applyAllSettings();
                }
            };

            // =================================================================
            // 事件处理器模块
            // =================================================================
            const handlers = {
                fetchBingSuggestions: async (query) => {
                    const url = `https://api.bing.com/osjson.aspx?query=${encodeURIComponent(query)}`;
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const data = await response.json();
                    return data[1]; 
                },
                fetchBaiduSuggestions: async (query) => {
                    const url = `https://suggestion.baidu.com/su?wd=${encodeURIComponent(query)}&p=3`;
                    const data = await utils.jsonp(url, 'cb');
                    return data.s;
                },

                globalClickHandler: (e) => {
                    const dropdownToggle = e.target.closest('[aria-haspopup="true"]');
                    const actionTarget = e.target.closest('[data-action]');
                    const shapeChoiceTarget = e.target.closest('.shape-choice');
                    const themeChoiceTarget = e.target.closest('.theme-choice');
                    const scopeMenuItem = e.target.closest('.scope-menu-item');

                    if (!e.target.closest('#context-menu') && !e.target.closest('#main-context-menu')) {
                        utils.closeAllDropdowns();
                    }
                    
                    if (!e.target.closest('#size-slider-panel') && !e.target.closest('[data-action="toggle-customize-panel"]')) {
                        dom.sizeSliderPanel.classList.remove('visible');
                    }

                    if (!e.target.closest('.search-container')) {
                       if(dom.searchSuggestionsContainer) dom.searchSuggestionsContainer.classList.remove('visible');
                    }
                    
                    if (shapeChoiceTarget) {
                        e.preventDefault();
                        core.applyShape(shapeChoiceTarget.dataset.shape);
                        core.saveUserData();
                        utils.closeAllDropdowns();
                        return;
                    }
                    
                    if (themeChoiceTarget) {
                        e.preventDefault();
                        const theme = themeChoiceTarget.dataset.theme;
                        state.userData.theme = theme;
                        core.applyTheme(theme);
                        core.saveUserData();
                        utils.closeAllDropdowns();
                        return;
                    }

                    if (scopeMenuItem) {
                        e.preventDefault();
                        state.activeSearchScopeId = scopeMenuItem.dataset.scopeId;
                        render.activeScopeTag();
                        render.searchScopeSelector();
                        utils.closeAllDropdowns();
                        return;
                    }

                    if (dropdownToggle) {
                        e.stopPropagation();
                        const menu = dropdownToggle.parentElement.querySelector('.dropdown-menu');
                        if (menu && !dropdownToggle.disabled) {
                            const wasVisible = menu.classList.contains('visible');
                            utils.closeAllDropdowns();
                            if (!wasVisible) {
                                utils.toggleDropdown(dropdownToggle, menu);
                            }
                        }
                        return;
                    }

                    if (actionTarget) {
                        e.preventDefault();
                        const action = actionTarget.dataset.action;
                        
                        switch(action) {
                            case 'edit-site':
                            case 'delete-site':
                                handlers.contextMenuAction(action);
                                break;
                            case 'add-site':
                                dom.addSiteForm.reset();
                                document.getElementById('add-site-icon-preview').src = 'https://placehold.co/32x32/f0f0f0/000000?text=?';
                                utils.populateCategoryDropdowns(dom.addSiteForm.querySelector('#site-category-select'));
                                dom.addSiteModal.classList.add('visible');
                                break;
                            case 'add-category':
                                dom.addCategoryModal.classList.add('visible');
                                break;
                            case 'refresh-page':
                                location.reload();
                                break;
                            case 'import-data':
                                core.importData();
                                break;
                            case 'export-data':
                                core.exportData();
                                break;
                            case 'toggle-customize-panel':
                                dom.sizeSliderPanel.classList.toggle('visible');
                                break;
                            case 'show-auth':
                                state.isRegisterMode = false;
                                render.authModal();
                                dom.authModal.classList.add('visible');
                                break;
                            case 'logout':
                                core.logout();
                                break;
                            case 'manage-scopes':
                                render.manageScopesModal();
                                dom.manageScopesModal.classList.add('visible');
                                break;
                            case 'edit-scope': {
                                const scopeId = actionTarget.dataset.scopeId;
                                const scope = state.userData.searchScopes.find(s => s.id === scopeId);
                                if (scope) {
                                    dom.scopeFormTitle.textContent = '编辑范围';
                                    dom.scopeEditId.value = scope.id;
                                    dom.scopeName.value = scope.name;
                                    dom.scopeSites.value = scope.sites.join('\n');
                                    dom.scopeFiletype.value = scope.filetype || '';
                                    dom.scopeIntitle.value = scope.intitle || '';
                                    dom.scopeIntext.value = scope.intext || '';
                                    dom.scopeExactPhrase.value = scope.exactPhrase || '';
                                    dom.scopeExcludeWords.value = scope.excludeWords || '';
                                    dom.scopeTimeRange.value = scope.timeRange || 'any';
                                    dom.scopeTimeRange.dispatchEvent(new Event('change'));
                                    dom.scopeStartDate.value = scope.startDate || '';
                                    dom.scopeEndDate.value = scope.endDate || '';
                                    dom.scopeFormCancel.classList.remove('hidden');
                                }
                                break;
                            }
                            case 'delete-scope': {
                                const scopeId = actionTarget.dataset.scopeId;
                                const scope = state.userData.searchScopes.find(s => s.id === scopeId);
                                if (scope) {
                                    utils.showConfirmModal(`确定要删除搜索范围 "${scope.name}" 吗？`, () => {
                                        state.userData.searchScopes = state.userData.searchScopes.filter(s => s.id !== scopeId);
                                        if (state.activeSearchScopeId === scopeId) {
                                            state.activeSearchScopeId = STATIC_CONFIG.CONSTANTS.DEFAULT_SCOPE_ID;
                                        }
                                        core.saveUserData();
                                        render.manageScopesModal();
                                        render.searchScopeSelector();
                                        render.activeScopeTag();
                                    });
                                }
                                break;
                            }
                            case 'fetch-icon-bqb':
                                const form = actionTarget.closest('form');
                                const urlInput = form.querySelector('input[type="text"][id$="-url"]');
                                const iconHiddenInput = form.querySelector('input[type="hidden"][id$="-icon-hidden"]');
                                const iconPreview = form.querySelector('.icon-preview');
                                let url = urlInput.value.trim();
                                if (url) {
                                    if (!url.match(/^https?:\/\//)) {
                                        url = 'https://' + url;
                                    }
                                    const bqbIconUrl = `https://icon.bqb.cool/?url=${url}`;
                                    iconHiddenInput.value = bqbIconUrl;
                                    iconPreview.src = bqbIconUrl;
                                } else {
                                    utils.showAlert('请先输入网站地址。');
                                }
                                break;
                            case 'switch-engine': {
                                const engineId = actionTarget.closest('.dropdown-item').dataset.engineId;
                                state.userData.activeSearchEngineId = engineId;
                                core.saveUserData();
                                render.searchEngineSwitcher();
                                break;
                            }
                            case 'manage-engines':
                                render.manageEnginesModal();
                                dom.manageEnginesModal.classList.add('visible');
                                break;
                            case 'edit-engine': {
                                const engineId = actionTarget.dataset.engineId;
                                const engine = state.userData.searchEngines.find(e => e.id === engineId);
                                if (engine) {
                                    dom.engineFormTitle.textContent = '编辑引擎';
                                    dom.engineEditId.value = engine.id;
                                    dom.engineName.value = engine.name;
                                    dom.engineUrl.value = engine.url;
                                    dom.engineIconUrl.value = engine.icon || '';
                                    dom.engineFormCancel.classList.remove('hidden');
                                }
                                break;
                            }
                            case 'delete-engine': {
                                const engineId = actionTarget.dataset.engineId;
                                if (state.userData.searchEngines.length <= 1) {
                                    utils.showAlert('必须保留至少一个搜索引擎。');
                                    return;
                                }
                                const engine = state.userData.searchEngines.find(e => e.id === engineId);
                                if (engine) {
                                    utils.showConfirmModal(`确定要删除搜索引擎 "${engine.name}" 吗？`, () => {
                                        state.userData.searchEngines = state.userData.searchEngines.filter(e => e.id !== engineId);
                                        if (state.userData.activeSearchEngineId === engineId) {
                                            state.userData.activeSearchEngineId = state.userData.searchEngines[0].id;
                                        }
                                        core.saveUserData();
                                        render.manageEnginesModal();
                                        render.searchEngineSwitcher();
                                    });
                                }
                                break;
                            }
                            case 'fetch-engine-icon': {
                                const url = dom.engineUrl.value;
                                if (url) {
                                    try {
                                        const urlObject = new URL(url);
                                        dom.engineIconUrl.value = `https://icon.bqb.cool/?url=${urlObject.origin}`;
                                    } catch(e) {
                                        utils.showAlert('请输入有效的搜索网址以获取图标。');
                                    }
                                } else {
                                    utils.showAlert('请先输入搜索网址。');
                                }
                                break;
                            }
                        }

                        utils.closeAllDropdowns();
                        return;
                    }

                    if (!e.target.closest('.modal-content') && !e.target.closest('#wallpaper-gallery-panel') && !e.target.closest('#wallpaper-gallery-trigger')) {
                        dom.wallpaperGalleryPanel.classList.remove('visible');
                    }
                },

                dockCategoryClick: (e) => {
                    const btn = e.target.closest('.dock-category-btn');
                    if (btn && !btn.classList.contains('active')) {
                        const activeBtn = document.querySelector('#dock-category-list .active');
                        if(activeBtn) activeBtn.classList.remove('active');
                        btn.classList.add('active');
                        render.navItems(btn.dataset.category);
                    }
                },

                formSubmit: async (e) => {
                    e.preventDefault();
                    const form = e.target;

                    if (form.id === 'search-form') {
                       core.performSearch(dom.searchInput.value.trim());
                       return;
                    }
                    
                    if (form.id === 'auth-form') {
                        dom.authSubmitBtn.disabled = true;
                        dom.authSubmitBtn.textContent = '处理中...';
                        const email = dom.authEmail.value;
                        const password = dom.authPassword.value;
                        if (state.isRegisterMode) {
                            await core.register(email, password);
                        } else {
                            await core.login(email, password);
                        }
                        return;
                    }

                    if (form.id === 'forgot-password-form') {
                        const email = document.getElementById('forgot-email-input').value;
                        await core.handlePasswordReset(email);
                        return;
                    }
                    
                    if (form.id === 'add-site-form' || form.id === 'edit-site-form') {
                        await utils.processSiteForm(form.id);
                    }

                    if (form.id === 'manage-scopes-form') {
                        const id = dom.scopeEditId.value;
                        const name = dom.scopeName.value.trim();
                        const sites = dom.scopeSites.value.trim().split('\n').map(s => s.trim()).filter(Boolean);
                        const filetype = dom.scopeFiletype.value.trim();
                        const intitle = dom.scopeIntitle.value.trim();
                        const intext = dom.scopeIntext.value.trim();
                        const exactPhrase = dom.scopeExactPhrase.value.trim();
                        const excludeWords = dom.scopeExcludeWords.value.trim();
                        const timeRange = dom.scopeTimeRange.value;
                        const startDate = dom.scopeStartDate.value;
                        const endDate = dom.scopeEndDate.value;

                        if (!name) {
                            utils.showAlert('范围名称不能为空！');
                            return;
                        }

                        const scopeData = { name, sites, filetype, intitle, intext, exactPhrase, excludeWords, timeRange, startDate, endDate };

                        if (id) {
                            const scopeIndex = state.userData.searchScopes.findIndex(s => s.id === id);
                            if (scopeIndex > -1) {
                                state.userData.searchScopes[scopeIndex] = { ...state.userData.searchScopes[scopeIndex], ...scopeData };
                            }
                        } else {
                            const newScope = { id: `scope_${Date.now()}`, ...scopeData };
                            state.userData.searchScopes.push(newScope);
                        }
                        
                        await core.saveUserData();
                        render.manageScopesModal();
                        render.searchScopeSelector();
                    }

                    if (form.id === 'manage-engines-form') {
                        const id = dom.engineEditId.value;
                        const name = dom.engineName.value.trim();
                        const url = dom.engineUrl.value.trim();
                        const icon = dom.engineIconUrl.value.trim();

                        if (!name || !url) {
                            utils.showAlert('引擎名称和网址不能为空！');
                            return;
                        }
                        if (!/\{query\}/i.test(url)) {
                            utils.showAlert('搜索网址必须包含 {query} 占位符。');
                            return;
                        }

                        const engineData = { name, url, icon };

                        if (id) {
                            const index = state.userData.searchEngines.findIndex(e => e.id === id);
                            if (index > -1) {
                                state.userData.searchEngines[index] = { ...state.userData.searchEngines[index], ...engineData };
                            }
                        } else {
                            const newEngine = { id: `engine_${Date.now()}`, ...engineData };
                            state.userData.searchEngines.push(newEngine);
                        }
                        
                        await core.saveUserData();
                        render.manageEnginesModal();
                        render.searchEngineSwitcher();
                    }
                },
                modalClose: (e) => {
                    const target = e.target;
                    if (target.matches('.modal-overlay') || target.dataset.action === 'close-modal') {
                        target.closest('.modal-overlay').classList.remove('visible');
                    }
                },
                
                handleContextMenu: (e) => {
                    const navItemEl = e.target.closest('.nav-item');
                    if (!navItemEl) return;

                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (state.isTheaterMode) return;
                    
                    utils.closeAllDropdowns();

                    const itemUrl = navItemEl.dataset.url;
                    
                    const sourceArray = state.userData.navItems;
                    const originalIndex = sourceArray.findIndex(i => i.url === itemUrl);
                    const itemData = sourceArray[originalIndex];

                    state.contextMenuItem = { itemData, originalIndex, sourceArray };

                    const menu = dom.contextMenu;
                    
                    menu.style.top = `${e.clientY}px`;
                    menu.style.left = `${e.clientX}px`;
                    menu.classList.add('visible');
                },

                handleMainContextMenu: (e) => {
                    if (state.isTheaterMode) return;
                    if (e.target.matches('input, textarea, select, [contenteditable="true"]')) return;
                    if (e.target.closest('.nav-item, .dock-action-btn, .dock-category-btn')) {
                         e.preventDefault();
                         return;
                    }

                    e.preventDefault();
                    utils.closeAllDropdowns();
                    
                    const menu = dom.mainContextMenu;
                    menu.style.top = `${e.clientY}px`;
                    menu.style.left = `${e.clientX}px`;
                    menu.classList.add('visible');
                },

                contextMenuAction: (action) => {
                    const { itemData, originalIndex, sourceArray } = state.contextMenuItem;
                    if (!itemData) return;

                    if (action === 'delete-site') {
                        utils.showConfirmModal(`确定要删除 "${itemData.name}" 吗？`, () => {
                            sourceArray.splice(originalIndex, 1);
                            core.saveUserData();
                            core.applyAllSettings();
                        });
                    } else if (action === 'edit-site') {
                        dom.editSiteForm.querySelector('#edit-site-index').value = originalIndex;
                        dom.editSiteForm.querySelector('#edit-site-name').value = itemData.name;
                        dom.editSiteForm.querySelector('#edit-site-url').value = itemData.url;
                        dom.editSiteForm.querySelector('#edit-site-icon-hidden').value = itemData.icon;
                        dom.editSiteForm.querySelector('#edit-site-icon-preview').src = itemData.icon;
                        utils.populateCategoryDropdowns(dom.editSiteForm.querySelector('#edit-site-category-select'), itemData.category);
                        dom.editSiteModal.classList.add('visible');
                    }
                    
                    utils.closeAllDropdowns();
                },
                
                handleDoubleClick: (e) => {
                    if (e.target.closest('a, button, input, select, .modal-content')) return;
                    if (state.isTheaterMode) {
                        core.exitTheaterMode();
                    } else {
                        core.enterTheaterMode();
                    }
                },
                
                showSuggestions: async () => {
                    const query = dom.searchInput.value.trim();
                    const mode = state.suggestionViewMode;
                    
                    if (dom.clearHistoryBtn) {
                        dom.clearHistoryBtn.classList.toggle('hidden', mode !== 'history' || state.userData.searchHistory.length === 0);
                    }
                    
                    if (!query && mode === 'suggestion') {
                        if (dom.searchSuggestionsContainer) {
                            dom.searchSuggestionsContainer.classList.remove('visible');
                        }
                        return;
                    }

                    if (mode === 'history') {
                        render.suggestions(state.userData.searchHistory, 'history');
                    } else { 
                        try {
                            const suggestions = await handlers.fetchBingSuggestions(query);
                            if (suggestions && suggestions.length > 0) {
                                render.suggestions(suggestions, 'suggestion');
                            } else {
                                throw new Error("No suggestions from Bing");
                            }
                        } catch (error) {
                            try {
                                const suggestions = await handlers.fetchBaiduSuggestions(query);
                                render.suggestions(suggestions, 'suggestion');
                            } catch (baiduError) {
                                if (dom.searchSuggestionsContainer) dom.searchSuggestionsContainer.classList.remove('visible');
                            }
                        }
                    }
                }
            };

            handlers.debouncedShowSuggestions = utils.debounce(handlers.showSuggestions, 250);
            
            // =================================================================
            // 事件监听器注册
            // =================================================================
            function addEventListeners() {
                document.addEventListener('click', handlers.globalClickHandler);
                document.querySelectorAll('form').forEach(f => f.addEventListener('submit', handlers.formSubmit));
                document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', handlers.modalClose));
                
                document.addEventListener('contextmenu', handlers.handleMainContextMenu);
                dom.navGrid.addEventListener('contextmenu', handlers.handleContextMenu);
                
                document.addEventListener('dblclick', handlers.handleDoubleClick);

                dom.navGrid.addEventListener('dragover', dnd.handleDragOver);
                dom.navGrid.addEventListener('drop', dnd.handleDrop);
                document.addEventListener('dragstart', dnd.handleDragStart);
                document.addEventListener('dragend', dnd.handleDragEnd);

                dom.importFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData && typeof importedData === 'object') {
                                utils.showConfirmModal('导入数据将覆盖您当前的设置，确定要继续吗？', async () => {
                                    state.userData = { ...JSON.parse(JSON.stringify(STATIC_CONFIG.DEFAULT_USER_DATA)), ...importedData };
                                    await core.saveUserData();
                                    core.applyAllSettings();
                                    utils.showAlert('数据导入成功！');
                                });
                            } else {
                                utils.showAlert('文件格式无效！', '导入错误');
                            }
                        } catch (error) {
                            utils.showAlert('导入失败，文件可能已损坏。', '导入错误');
                        } finally {
                            dom.importFileInput.value = '';
                        }
                    };
                    reader.readAsText(file);
                });
                dom.sizeSlider.addEventListener('input', (e) => document.documentElement.style.setProperty('--nav-item-size', `${e.target.value}px`));
                dom.sizeSlider.addEventListener('change', (e) => {
                    state.userData.navSize = parseInt(e.target.value, 10);
                    core.saveUserData();
                });
                
                dom.increaseSizeBtn.addEventListener('click', () => {
                    dom.sizeSlider.value = Math.min(parseInt(dom.sizeSlider.value, 10) + 10, dom.sizeSlider.max);
                    dom.sizeSlider.dispatchEvent(new Event('input', { bubbles: true }));
                    dom.sizeSlider.dispatchEvent(new Event('change', { bubbles: true }));
                });

                dom.decreaseSizeBtn.addEventListener('click', () => {
                    dom.sizeSlider.value = Math.max(parseInt(dom.sizeSlider.value, 10) - 10, dom.sizeSlider.min);
                    dom.sizeSlider.dispatchEvent(new Event('input', { bubbles: true }));
                    dom.sizeSlider.dispatchEvent(new Event('change', { bubbles: true }));
                });

                dom.confirmModalBtn.addEventListener('click', () => {
                    if (typeof state.confirmCallback === 'function') {
                        state.confirmCallback();
                    }
                    state.confirmCallback = null;
                    dom.confirmModal.classList.remove('visible');
                });
                
                if (dom.authSwitch) {
                    dom.authSwitch.addEventListener('click', (e) => {
                        if (e.target.tagName === 'A') {
                            e.preventDefault();
                            state.isRegisterMode = !state.isRegisterMode;
                            render.authModal();
                        }
                    });
                }
                
                dom.forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    dom.authModal.classList.remove('visible');
                    dom.forgotPasswordModal.classList.add('visible');
                });
                
                dom.dockContainer.addEventListener('click', (e) => {
                    const categoryBtn = e.target.closest('.dock-category-btn');
                    if (categoryBtn) {
                        handlers.dockCategoryClick(e);
                        return;
                    }

                    const pinBtn = e.target.closest('#pin-btn');
                    if (pinBtn) {
                        const isPinned = dom.dockContainer.classList.toggle('pinned');
                        pinBtn.classList.toggle('pinned', isPinned);
                        state.userData.isDockPinned = isPinned;
                        core.saveUserData();
                        return;
                    }
                    
                    const addBtn = e.target.closest('#add-btn');
                    if (addBtn) {
                        e.stopPropagation();
                        const menu = addBtn.parentElement.querySelector('#add-menu');
                        if (menu) {
                           utils.toggleDropdown(addBtn, menu);
                        }
                    }
                });
                
                if (dom.searchInput) {
                    dom.searchInput.addEventListener('focus', () => {
                        dom.searchContainer.classList.add('focused');
                        if (!dom.searchScopeMenu.classList.contains('visible')) {
                            handlers.showSuggestions();
                        }
                    });
                    dom.searchInput.addEventListener('blur', () => dom.searchContainer.classList.remove('focused'));
                    dom.searchInput.addEventListener('input', () => {
                        dom.searchContainer.classList.toggle('has-input', dom.searchInput.value.length > 0);
                        state.activeSuggestionIndex = -1;
                        state.suggestionViewMode = 'suggestion';
                        handlers.debouncedShowSuggestions();
                    });
                    dom.searchInput.addEventListener('keydown', (e) => {
                         if (e.key === 'Tab') {
                            e.preventDefault();
                            utils.toggleDropdown(dom.searchScopeBtn, dom.searchScopeMenu);
                            return;
                        }
                        if (!dom.searchSuggestionsContainer?.classList.contains('visible')) return;
                        const items = dom.suggestionContent.querySelectorAll('.suggestion-item');
                        if (items.length === 0) return;
                        
                        let newIndex = state.activeSuggestionIndex;
                        if (e.key === 'ArrowDown') { e.preventDefault(); newIndex = (state.activeSuggestionIndex + 1) % items.length; }
                        else if (e.key === 'ArrowUp') { e.preventDefault(); newIndex = (state.activeSuggestionIndex - 1 + items.length) % items.length; }
                        else if (e.key === 'Enter') { if (state.activeSuggestionIndex > -1) { e.preventDefault(); items[state.activeSuggestionIndex].click(); } return; }
                        else { return; }
                        
                        state.activeSuggestionIndex = newIndex;
                        items.forEach((item, index) => item.classList.toggle('active', index === newIndex));
                        if (state.activeSuggestionIndex > -1) { dom.searchInput.value = items[state.activeSuggestionIndex].dataset.value; }
                    });
                }
                
                dom.suggestionTabs?.addEventListener('click', (e) => {
                    const tab = e.target.closest('.suggestion-tab');
                    if (tab && !tab.classList.contains('active')) {
                        dom.suggestionTabs.querySelector('.active').classList.remove('active');
                        tab.classList.add('active');
                        state.suggestionViewMode = tab.dataset.type;
                        handlers.showSuggestions();
                    }
                });

                dom.clearHistoryBtn?.addEventListener('click', () => {
                    utils.showConfirmModal('确定要清空所有搜索历史记录吗？此操作无法撤销。', () => {
                        state.userData.searchHistory = [];
                        core.saveUserData();
                        handlers.showSuggestions();
                        utils.showAlert('搜索历史已清空。');
                    });
                });

                dom.suggestionContent?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const target = e.target;

                    if (target.classList.contains('remove-history-btn')) {
                        const index = parseInt(target.dataset.index, 10);
                        state.userData.searchHistory.splice(index, 1);
                        core.saveUserData();
                        render.suggestions(state.userData.searchHistory, 'history');
                        return;
                    }
                    const item = target.closest('.suggestion-item');
                    if (item) {
                        const value = item.dataset.value;
                        dom.searchInput.value = value;
                        dom.searchSuggestionsContainer.classList.remove('visible');
                        core.performSearch(value);
                    }
                });
                
                dom.scopeFormCancel.addEventListener('click', () => render.manageScopesModal());
                dom.scopeSites.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    document.execCommand('insertText', false, pastedText.split('\n').map(utils.purifyUrl).join('\n'));
                });
                dom.scopeSites.addEventListener('blur', (e) => e.target.value = e.target.value.split('\n').map(utils.purifyUrl).join('\n'));
                dom.scopeTimeRange.addEventListener('change', (e) => {
                    const value = e.target.value;
                    dom.scopeCustomDateRange.classList.toggle('hidden', !['custom', 'after', 'before'].includes(value));
                    dom.startDateContainer.classList.toggle('hidden', !['custom', 'after'].includes(value));
                    dom.endDateContainer.classList.toggle('hidden', !['custom', 'before'].includes(value));
                });

                dom.engineFormCancel.addEventListener('click', () => render.manageEnginesModal());
                dom.engineUrl.addEventListener('paste', (e) => {
                    e.preventDefault();
                    e.target.value = utils.formatSearchUrl((e.clipboardData || window.clipboardData).getData('text'));
                });

                dom.prevWallpaperBtn.addEventListener('click', () => { core.stopSlideshow(); core.handlePrevWallpaper(); });
                dom.nextWallpaperBtn.addEventListener('click', () => { core.stopSlideshow(); core.handleNextWallpaper(); });
                dom.playPauseWallpaperBtn.addEventListener('click', core.toggleSlideshow);
                dom.downloadWallpaperBtn.addEventListener('click', core.handleDownloadWallpaper);
                dom.toggleWatermarkBtn.addEventListener('click', () => {
                    state.userData.showWatermark = !state.userData.showWatermark;
                    core.saveUserData();
                    render.watermark(dom.wallpaperInfo.textContent);
                });
                dom.wallpaperGalleryTrigger.addEventListener('click', core.toggleWallpaperGallery);
                
                // [FIXED] Wallpaper category click logic
                dom.wallpaperGalleryCategoriesContainer?.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the global click handler from closing the panel
                    const btn = e.target.closest('.wallpaper-gallery-category-btn');
                    if (btn && !btn.classList.contains('active')) {
                        state.activeWallpaperGalleryCategory = btn.dataset.category;
                        state.currentWallpaperPage = 1;
                        render.wallpaperGalleryCategories();
                        render.wallpaperGallery(true);
                    }
                });

                dom.wallpaperGalleryGrid.addEventListener('click', (e) => {
                    const item = e.target.closest('.wallpaper-gallery-item');
                    if (item) {
                        const { category, index, url } = item.dataset;
                        core.setWallpaperFromGallery(category, parseInt(index, 10), url);
                    }
                });

                dom.wallpaperContainer.addEventListener('mousemove', () => {
                    dom.wallpaperContainer.classList.add('controls-visible');
                    clearTimeout(state.controlsTimeout);
                    state.controlsTimeout = setTimeout(() => dom.wallpaperContainer.classList.remove('controls-visible'), 3000);
                });
                dom.wallpaperContainer.addEventListener('mouseleave', () => dom.wallpaperContainer.classList.remove('controls-visible'));
                
                dom.wallpaperGalleryPanel.addEventListener('scroll', () => {
                    if (state.isLoadingMoreWallpapers) return;
                    const { scrollTop, scrollHeight, clientHeight } = dom.wallpaperGalleryPanel;
                    if (scrollHeight - scrollTop - clientHeight < 200) {
                        state.currentWallpaperPage++;
                        render.wallpaperGallery();
                    }
                });
            }
            
            // =================================================================
            // 应用初始化
            // =================================================================
            const init = async () => {
                DOMElementsToCache.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    dom[camelCaseId] = document.getElementById(id);
                });
                dom.body = document.body;
                
                if (!supabase) {
                    dom.customAlertMessage.style.whiteSpace = 'pre-wrap';
                    utils.showAlert(
                        '后端服务未配置！\n\n请在 HTML 代码的 <script> 部分找到 SUPABASE_CONFIG 变量，并填入您自己的 Supabase 项目 URL 和 Anon Key。',
                        '配置错误'
                    );
                }

                render.aiTools();
                render.themes();
                render.shapeMenu();
                render.dockControls();
                render.wallpaperGalleryCategories();
                
                if (supabase) {
                    supabase.auth.onAuthStateChange(async (event, session) => {
                        const user = session?.user || null;
                        state.currentUser = user;
                        state.isLoggedIn = !!user;
                        
                        console.log(`Auth event: ${event}`, session);
                        
                        if (event === 'SIGNED_OUT') {
                            await storage.set(STATIC_CONFIG.DEFAULT_USER_DATA);
                        }

                        render.userActions();
                        await core.loadUserData();
                    });
                } else {
                    await core.loadUserData();
                }
                
                core.updateClock();
                setInterval(core.updateClock, 1000);

                addEventListeners();
            };

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
</body>
</html>
